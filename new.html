<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Safety Supervisor Challenge – Health & Safety</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-..."
        crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
    .control-item,.emergency-step{       
    touch-action: none;
  }
  @media (max-width:640px){
    .drop-zone{ min-height:80px; }   
  }
    html{
      font-size:clamp(0.875rem,0.9rem+0.25vw,1.125rem);
    }
    body{font-family:'Inter',sans-serif;}
    .hazard-apple{
      position:absolute;
      width:7vw;max-width:35px;min-width:28px;
      aspect-ratio:1/1;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;font-size:6vw;font-size:28px;
      animation:sway 3s ease-in-out infinite;
      transition:transform .3s,filter .3s;
    }
    .hazard-apple:hover{transform:scale(1.2);filter:brightness(1.2);}
    @keyframes sway{0%,100%{transform:rotate(-2deg);}50%{transform:rotate(2deg);}}
    .found-apple{animation:none!important;opacity:.5;}
    #orchard-scene{overflow:hidden;}
    .hazard-modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,.55);z-index:1000;}
    .control-item{transition:transform .25s,box-shadow .25s;}
    .control-item:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgb(0 0 0 / .15);}
    .drop-zone{min-height:60px;border:2px dashed #d1d5db;transition:all .3s;}
    .drop-zone.drag-over{border-color:#3b82f6;background-color:rgb(59 130 246 / .1);}
    .progress-bar{transition:width .6s;}
    .badge{animation:bounceIn .6s;}
    @keyframes bounceIn{0%{transform:scale(0);}50%{transform:scale(1.1);}100%{transform:scale(1);}}
    .mic-btn{
      display:inline-flex;align-items:center;justify-content:center;
      width:2.5rem;height:2.5rem;
      border-radius:.75rem;
      background:#e0f2fe;color:#0369a1;
      transition:background .3s;
    }
    .mic-btn:hover{background:#bae6fd;}
    .mic-btn.recording{background:#fef08a;color:#92400e;}
    .safe-container{max-width:90rem;margin-inline:auto;padding-inline:1rem;}
    .ear-btn{
  background:none; border:0; padding:0;
  cursor:pointer; font-size:0.9em;
}
.ear-btn:hover{ color:#0369a1; }
  </style>
</head>

<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">

<header class="bg-white shadow-sm border-b-4 border-green-500">
  <div class="safe-container py-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div>
      <h1 class="text-[1.55rem] sm:text-2xl font-bold text-gray-900">
        🛡️ Safety Supervisor Challenge
      </h1>
      <p class="text-sm sm:text-base text-gray-600">
        Health & Safety at Work Act 2015 – Primary Industry Assessment
      </p>
    </div>
    <div class="flex items-center justify-center">
      <div class="text-center">
        <div class="text-2xl font-bold text-blue-600">📝</div>
        <div class="text-xs text-gray-500">Assessment</div>
      </div>
    </div>
  </div>

  <!-- Progress -->
  <div class="safe-container">
    <div class="mt-2 flex justify-between text-xs sm:text-sm text-gray-600">
      <span>Progress</span><span id="progress-text">0/5 Tasks Complete</span>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-3">
      <div id="progress-bar"
           class="progress-bar bg-gradient-to-r from-green-500 to-blue-500 h-3 rounded-full"
           style="width:0%"></div>
    </div>
  </div>
</header>
<main class="safe-container py-8">

  <!-- ========== WELCOME ========== -->
  <section id="welcome-screen"
           class="bg-white rounded-xl shadow-lg p-6 sm:p-8 text-center space-y-6">
    <div class="text-6xl">🍎</div>
    <h2 class="text-[1.75rem] font-bold text-gray-900">
      Welcome to Hei Whanake Orchard!
    </h2>
    <p class="text-gray-600">
      You're the Safety Supervisor for the day during our busy harvest season.
      Your mission: ensure our workplace meets all
      <span class="font-semibold">Health & Safety at Work Act 2015</span> requirements!
    </p>

    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 text-left rounded-md">
      <h3 class="font-semibold text-yellow-800 mb-2">Your Tasks Today:</h3>
      <ul class="text-yellow-700 space-y-1">
        <li>🔍 <strong>Hazard Hunt:</strong> Find 8 hazards in our orchard scene</li>
        <li>🎯 <strong>Risk‑Buster:</strong> Match controls to hazards</li>
        <li>📋 <strong>Accident Log:</strong> Complete incident reporting</li>
        <li>🚨 <strong>Emergency Dash:</strong> Handle an emergency</li>
        <li>⚖️ <strong>PCBU Duty Check:</strong> Evaluate duty‑of‑care cases</li>
      </ul>
    </div>

    <button onclick="startAssessment()"
            class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg
                   text-lg transition-colors">
      Start Your Shift 🚀
    </button>
  </section>
 <!-- ========== TASK 1 – HAZARD HUNT ========== -->
  <section id="task1"
           class="hidden bg-white rounded-xl shadow-lg p-4 sm:p-6 space-y-6">

    <!-- header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-900">
        🔍 Task 1 – Hazard Hunt
      </h2>
      <span class="text-sm text-gray-600">
        Found: <span id="hazards-found">0</span>/8
      </span>
    </div>

    <p class="text-gray-600">
      Tap the apples 🍎 in the orchard to identify hazards.
      For each hazard describe what injury or illness it could cause.
    </p>

    <!-- orchard scene -->
    <!-- 🔄 MAJOR CHANGE: responsive h-[60vw] keeps aspect + %‑based apple coords -->
    <div id="orchard-scene"
         class="relative rounded-lg bg-center bg-cover mx-auto"
         style="background-image:url('images/orchard.jpg');height:60vw;max-height:500px;">

      <!-- positions converted to % of 640×500 reference -->
      <div class="hazard-apple" style="top:24%; left:18.75%;" data-hazard="1">🍎</div>
      <div class="hazard-apple" style="top:20%; left:31.25%;" data-hazard="2">🍎</div>
      <div class="hazard-apple" style="top:32%; left:50%;" data-hazard="3">🍎</div>
      <div class="hazard-apple" style="top:24%; left:71.875%;" data-hazard="4">🍎</div>
      <div class="hazard-apple" style="top:16%; left:87.5%;" data-hazard="5">🍎</div>
      <div class="hazard-apple" style="top:30%; left:54.69%;" data-hazard="6">🍎</div>
      <div class="hazard-apple" style="top:12%; left:14.06%;" data-hazard="7">🍎</div>
      <div class="hazard-apple" style="top:36%; left:35.94%;" data-hazard="8">🍎</div>
    </div>

    <!-- hazard modal -->
    <div id="hazard-modal" class="hazard-modal hidden">
      <div class="bg-white rounded-xl shadow-2xl p-6 w-[90vw] max-w-md mx-2 space-y-4">
        <div class="text-center space-y-1">
          <div class="text-4xl">⚠️</div>
          <h3 id="modal-hazard-title" class="text-lg font-bold text-gray-900">
            Hazard Identified!
          </h3>
        </div>

        <p id="modal-hazard-description" class="text-gray-700 text-sm"></p>

        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded-md">
          <p class="text-sm text-yellow-800">
            <strong>Your task:</strong>
            Describe the potential injury or illness this hazard could cause.
          </p>
        </div>

        <!-- textarea gets real‑time STT -->
        <label for="hazard-description-input"
               class="block text-sm font-medium text-gray-700 mb-1">
          Describe the injury or illness:
        </label>
        <div class="flex items-start gap-2">
          <textarea id="hazard-description-input"
                    class="flex-1 p-3 border border-gray-300 rounded-lg speech-enabled"
                    rows="3"
                    placeholder="e.g., Falls from height could cause fractures…"></textarea>
        </div>

        <div class="flex gap-3 pt-2">
          <button onclick="submitHazardDescription()"
                  class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-lg">
            Submit ✅
          </button>
          <button onclick="closeHazardModal()"
                  class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 rounded-lg">
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- list container & task complete -->
    <div id="hazard-list"
         class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>

    <button id="task1-complete" onclick="completeTask1()"
            class="hidden bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg">
      Complete Hazard Hunt ✅
    </button>
  </section>
</div> 
 
      <!-- Task 2: Eliminate vs Minimise (exactly 3) -->
<div id="task2" class="hidden bg-white rounded-xl shadow-lg p-6 mb-8">
 <li>🎯 <strong>Eliminate vs Minimise:</strong> Choose and describe controls</li>
  <p class="text-gray-700 mb-4">
    Pick <strong>exactly 3</strong> hazards (from Task 1). For each one:
    <span class="font-semibold">choose Eliminate or Minimise</span> and
    <span class="font-semibold">describe</span> the control you’d use.
  </p>

  <div class="bg-blue-50 border border-blue-200 p-3 rounded-lg text-sm text-blue-800 mb-4">
    ✅ Mobile-friendly: tap to select & type. All three cards must be completed.
  </div>

  <!-- Progress -->
  <div class="flex items-center justify-between mb-3 text-sm text-gray-600">
    <span>Cards complete:</span>
    <span id="t2-progress">0/3</span>
  </div>
  <div class="w-full bg-gray-200 rounded-full h-2 mb-6">
    <div id="t2-bar" class="progress-bar bg-gradient-to-r from-green-500 to-blue-500 h-2 rounded-full" style="width:0%"></div>
  </div>

  <!-- Three required cards -->
  <div id="t2-cards" class="grid grid-cols-1 gap-4">
    <!-- Cards injected by initializeTask2() -->
  </div>

  <button id="task2-complete"
          onclick="completeTask2()"
          class="hidden mt-4 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg">
    Submit Eliminate/Minimise ✅
  </button>
</div>

        <!-- Task 3: Accident Log Mini-Sim -->
        <div id="task3" class="hidden bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">📋 Task 3: Accident Log Mini-Sim</h2>
            
            <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
                <h3 class="font-semibold text-red-800 mb-2">⚠️ Incident Report</h3>
                <p class="text-red-700">A worker has slipped on wet concrete near the pack house and twisted their ankle. They can walk but are in pain. Complete the formal reporting process.</p>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">1. What type of form should be completed?</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="form-type" value="incident" class="mr-2">
                            <span>Incident/Accident Report Form</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="form-type" value="hazard" class="mr-2">
                            <span>Hazard Report Form</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="form-type" value="inspection" class="mr-2">
                            <span>Safety Inspection Form</span>
                        </label>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">2. Key details to record (select all that apply):</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" name="details" value="time-date" class="mr-2">
                            <span>Time and date of incident</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="details" value="location" class="mr-2">
                            <span>Exact location where incident occurred</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="details" value="witnesses" class="mr-2">
                            <span>Names of witnesses</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="details" value="weather" class="mr-2">
                            <span>Weather conditions</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="details" value="injury" class="mr-2">
                            <span>Nature and extent of injury</span>
                        </label>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">3. Who must be notified immediately?</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="notify" value="worksafe" class="mr-2">
                            <span>WorkSafe New Zealand only</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="notify" value="supervisor" class="mr-2">
                            <span>Immediate supervisor/manager</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="notify" value="police" class="mr-2">
                            <span>New Zealand Police</span>
                        </label>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">4. When must WorkSafe NZ be notified for this type of incident?</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="worksafe-timing" value="immediately" class="mr-2">
                            <span>Immediately (this is a notifiable incident)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="worksafe-timing" value="48hours" class="mr-2">
                            <span>Within 48 hours</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="worksafe-timing" value="not-required" class="mr-2">
                            <span>Not required for this incident</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <button onclick="checkTask3()" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">
                Submit Report 📝
            </button>
            
            <button id="task3-complete" onclick="completeTask3()" class="hidden mt-4 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg">
                Complete Accident Log ✅
            </button>
        </div>

        <!-- Task 4: Emergency Dash -->
        <div id="task4" class="hidden bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">🚨 Task 4: Emergency Dash</h2>
            
            <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
                <h3 class="font-semibold text-red-800 mb-2">🚨 Emergency Situation</h3>
                <p class="text-red-700">A worker has been seriously injured by machinery and is unconscious. You are first on scene. Put the emergency procedures in the correct order.</p>
            </div>
            
            <div class="mb-6">
                <h4 class="font-semibold text-gray-800 mb-3">Drag the steps into the correct order (1-6):</h4>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-3">
                        <h5 class="font-medium text-gray-700">Emergency Steps (drag these):</h5>
                        <div id="emergency-steps" class="space-y-2">
                            <div class="emergency-step bg-blue-100 border border-blue-300 rounded-lg p-3 cursor-move" draggable="true" data-step="isolate">
                                🚧 Isolate the area and ensure scene safety
                            </div>
                            <div class="emergency-step bg-blue-100 border border-blue-300 rounded-lg p-3 cursor-move" draggable="true" data-step="assess">
                                🩺 Check for responsiveness and breathing
                            </div>
                            <div class="emergency-step bg-blue-100 border border-blue-300 rounded-lg p-3 cursor-move" draggable="true" data-step="call111">
                                📞 Call 111 for emergency services
                            </div>
                            <div class="emergency-step bg-blue-100 border border-blue-300 rounded-lg p-3 cursor-move" draggable="true" data-step="firstaid">
                                🏥 Provide first aid as trained
                            </div>
                            <div class="emergency-step bg-blue-100 border border-blue-300 rounded-lg p-3 cursor-move" draggable="true" data-step="notify">
                                📋 Notify supervisor and WorkSafe NZ
                            </div>
                            <div class="emergency-step bg-blue-100 border border-blue-300 rounded-lg p-3 cursor-move" draggable="true" data-step="preserve">
                                🔍 Preserve scene for investigation
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <h5 class="font-medium text-gray-700">Correct Order:</h5>
                        <div id="emergency-sequence" class="space-y-2">
                            <div class="drop-zone bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-3 text-center text-gray-500 min-h-16" data-position="1">
                                Step 1: Drop here
                            </div>
                            <div class="drop-zone bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-3 text-center text-gray-500 min-h-16" data-position="2">
                                Step 2: Drop here
                            </div>
                            <div class="drop-zone bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-3 text-center text-gray-500 min-h-16" data-position="3">
                                Step 3: Drop here
                            </div>
                            <div class="drop-zone bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-3 text-center text-gray-500 min-h-16" data-position="4">
                                Step 4: Drop here
                            </div>
                            <div class="drop-zone bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-3 text-center text-gray-500 min-h-16" data-position="5">
                                Step 5: Drop here
                            </div>
                            <div class="drop-zone bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-3 text-center text-gray-500 min-h-16" data-position="6">
                                Step 6: Drop here
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <button onclick="checkTask4()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">
                Check Emergency Sequence 🚨
            </button>
            
            <button id="task4-complete" onclick="completeTask4()" class="hidden mt-4 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg">
                Complete Emergency Dash ✅
            </button>
            <!-- Add inside Task 4, below the sequence list -->
<div class="mt-2">
  <button type="button" onclick="clearEmergencySequence()"
          class="text-sm underline text-gray-600 hover:text-gray-800">
    Clear sequence
  </button>
</div>
        </div>

<!-- Task 5: Safety Court Simulation -->
<div id="task5" class="hidden bg-white rounded-xl shadow-lg p-6 mb-8">
  <div class="text-center mb-6">
    <div class="text-6xl mb-4">⚖️</div>
    <h2 class="text-3xl font-bold text-gray-900 mb-2">Safety Court: Judge's Chamber</h2>
    <p class="text-lg text-gray-600">You are the presiding judge in the Health & Safety Court. Review each case and deliver your verdict!</p>
    <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mt-4">
      <p class="text-amber-800 font-medium">⚖️ Cases Reviewed: <span id="cases-reviewed">0</span>/2 | Verdicts Delivered: <span id="verdicts-delivered">0</span>/2</p>
    </div>
  </div>

  <!-- Court Cases -->
  <div id="court-cases" class="space-y-6">
    <!-- Case 1 -->
    <div id="case1" class="case-card border-2 border-gray-300 rounded-xl p-6 transition-all duration-300 hover:shadow-lg">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-gray-900">📋 Case #001: Kiwi Orchard Ltd</h3>
        <div class="case-status bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium">
          Under Review
        </div>
      </div>

      <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-4">
        <h4 class="font-semibold text-red-800 mb-2">⚠️ Charges: Inadequate Worker Training & Supervision</h4>
        <p class="text-red-700 text-sm"><strong>Evidence:</strong> Kiwi Orchard Ltd hired 5 new seasonal workers. They received only a 10-minute safety briefing, basic PPE, and were assigned to work with experienced pickers. No formal training records were kept, and there was no ongoing supervision during the busy harvest period.</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h5 class="font-semibold text-blue-800 mb-2">🛡️ Defense Arguments:</h5>
          <ul class="text-blue-700 text-sm space-y-1">
            <li>• Provided safety briefing on first day</li>
            <li>• Supplied basic PPE (glasses & gloves)</li>
            <li>• Paired new workers with experienced staff</li>
            <li>• Busy harvest season - limited time</li>
          </ul>
        </div>

        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
          <h5 class="font-semibold text-purple-800 mb-2">⚖️ HSWA 2015 Requirements:</h5>
          <ul class="text-purple-700 text-sm space-y-1">
            <li>• Adequate training & supervision</li>
            <li>• Formal training records</li>
            <li>• Ongoing safety monitoring</li>
            <li>• Competency verification</li>
          </ul>
        </div>
      </div>

      <div class="verdict-section bg-gray-50 rounded-lg p-4">
        <h5 class="font-semibold text-gray-800 mb-3">👨‍⚖️ Your Verdict:</h5>
        <div class="space-y-3">
          <div class="flex space-x-4">
            <button onclick="deliverVerdict(1, 'guilty')" class="verdict-btn flex-1 bg-red-100 hover:bg-red-200 border-2 border-red-300 text-red-800 font-semibold py-3 px-4 rounded-lg transition-all">
              ⚖️ GUILTY - PCBU Failed Duty
            </button>
            <button onclick="deliverVerdict(1, 'not-guilty')" class="verdict-btn flex-1 bg-green-100 hover:bg-green-200 border-2 border-green-300 text-green-800 font-semibold py-3 px-4 rounded-lg transition-all">
              ⚖️ NOT GUILTY - Duty Met
            </button>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">📝 Judicial Reasoning (required):</label>
            <textarea id="case1-reasoning" class="w-full p-3 border border-gray-300 rounded-lg" rows="2" placeholder="Explain your legal reasoning based on HSWA 2015 requirements..."></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Case 2 -->
    <div id="case2" class="case-card border-2 border-gray-300 rounded-xl p-6 transition-all duration-300 hover:shadow-lg">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-gray-900">📋 Case #002: Apple Valley Orchards</h3>
        <div class="case-status bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium">
          Under Review
        </div>
      </div>

      <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
        <h4 class="font-semibold text-blue-800 mb-2">🔍 Charges: Questioned Safety Management System</h4>
        <p class="text-blue-700 text-sm"><strong>Evidence:</strong> Apple Valley Orchards conducts monthly safety inspections and maintains a hazard register. When workers reported a broken ladder, it was immediately removed and replaced within 24 hours. The company provides comprehensive training, regular toolbox talks, and has clear hazard reporting procedures. All incidents are investigated with corrective actions implemented.</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <h5 class="font-semibold text-green-800 mb-2">✅ Evidence of Compliance:</h5>
          <ul class="text-green-700 text-sm space-y-1">
            <li>• Monthly safety inspections</li>
            <li>• Maintained hazard register</li>
            <li>• Immediate hazard response (24hrs)</li>
            <li>• Comprehensive training program</li>
            <li>• Regular toolbox talks</li>
            <li>• Clear reporting procedures</li>
            <li>• Incident investigation system</li>
          </ul>
        </div>

        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
          <h5 class="font-semibold text-orange-800 mb-2">⚠️ Prosecution Claims:</h5>
          <ul class="text-orange-700 text-sm space-y-1">
            <li>• Equipment still broke despite inspections</li>
            <li>• Should have prevented ladder failure</li>
            <li>• Reactive rather than proactive</li>
            <li>• Workers were exposed to risk</li>
          </ul>
        </div>
      </div>

      <div class="verdict-section bg-gray-50 rounded-lg p-4">
        <h5 class="font-semibold text-gray-800 mb-3">👨‍⚖️ Your Verdict:</h5>
        <div class="space-y-3">
          <div class="flex space-x-4">
            <button onclick="deliverVerdict(2, 'guilty')" class="verdict-btn flex-1 bg-red-100 hover:bg-red-200 border-2 border-red-300 text-red-800 font-semibold py-3 px-4 rounded-lg transition-all">
              ⚖️ GUILTY - PCBU Failed Duty
            </button>
            <button onclick="deliverVerdict(2, 'not-guilty')" class="verdict-btn flex-1 bg-green-100 hover:bg-green-200 border-2 border-green-300 text-green-800 font-semibold py-3 px-4 rounded-lg transition-all">
              ⚖️ NOT GUILTY - Duty Met
            </button>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">📝 Judicial Reasoning (required):</label>
            <textarea id="case2-reasoning" class="w-full p-3 border border-gray-300 rounded-lg" rows="2" placeholder="Explain your legal reasoning based on HSWA 2015 requirements..."></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="text-center mt-8">
    <button id="task5-complete" onclick="completeTask5()" class="hidden bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg text-lg">
      📜 Court Session Complete - Submit Verdicts ⚖️
    </button>
  </div>
</div>

<!--  MASTER GAME SCRIPT -->
<script>

const pcbuCases = [
  {
    id: 1,
    title: 'Training & Supervision',
    story: `Kiwi Orchard Ltd has hired five new seasonal workers for harvest.
            The manager gives them a 10‑minute safety briefing on day one,
            hands out safety glasses and gloves, then assigns them to work
            with experienced pickers. No formal training records are kept and
            there’s no ongoing supervision during the busy period.`,
    options: [
      { value: 'yes', label: 'Yes – basic briefing and PPE were provided' },
      { value: 'no',  label: 'No – training, supervision and records are inadequate' }
    ],
    correct: 'no',
    feedbackRight: '✅ Correct – PCBU failed to provide adequate training & supervision.',
    feedbackWrong: '❌ Not quite. A quick briefing and PPE alone aren’t enough.'
  },
  {
    id: 2,
    title: 'Hazard Management',
    story: `Apple Valley Orchards conducts monthly safety inspections and keeps
            a hazard register. When workers report a broken ladder, it is
            removed from service and replaced within 24 hours. Comprehensive
            safety training, regular toolbox talks and clear reporting
            procedures are in place. All incidents are investigated and
            corrective actions implemented.`,
    options: [
      { value: 'yes', label: 'Yes – systematic approach to hazard management' },
      { value: 'no',  label: 'No – they should have prevented the ladder breaking' }
    ],
    correct: 'yes',
    feedbackRight: '✅ Spot on – they’re meeting their duty through systematic hazard management.',
    feedbackWrong: '❌ Check again – think about the steps they already took.'
  }
];

let pcbuXP   = 0;
let pcbuLives = 3;

function initializeTask5 () {
  pcbuXP   = 0;
  pcbuLives = 3;
  updatePCBUHUD();

  const wrapper = document.getElementById('pcbu-cases');
  wrapper.innerHTML = '';

  pcbuCases.forEach(cs => {
    const card = document.createElement('div');
    card.className = 'border border-gray-200 rounded-lg p-4 bg-gray-50';

    card.innerHTML = `
      <h4 class="font-semibold text-gray-800 mb-2">${cs.title}</h4>
      <p class="text-gray-700 mb-4">${cs.story}</p>
      ${cs.options.map(opt => `
        <label class="flex items-center mb-1">
          <input type="radio" name="pcbu-${cs.id}" value="${opt.value}" class="mr-2">
          <span>${opt.label}</span>
        </label>`).join('')}
      <button onclick="judgeCase(${cs.id})"
              class="mt-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-1 px-3 rounded">
        Judge ⚖️
      </button>
      <div id="pcbu-feedback-${cs.id}" class="mt-2 text-sm"></div>
    `;
    wrapper.appendChild(card);
  });
}

function judgeCase (id) {
  const cs = pcbuCases.find(c => c.id === id);
  const chosen = document.querySelector(`input[name="pcbu-${id}"]:checked`);
  if (!chosen) { alert('Select an answer first!'); return; }

  const box = document.getElementById(`pcbu-feedback-${id}`);

  if (chosen.value === cs.correct) {
    box.textContent = cs.feedbackRight;
    box.className   = 'mt-2 text-green-600';
    pcbuXP += 100;
    lockCase(id);
  } else {
    box.textContent = cs.feedbackWrong;
    box.className   = 'mt-2 text-red-600';
    pcbuLives -= 1;
  }

  updatePCBUHUD();

  if (pcbuXP === pcbuCases.length * 100) {
    document.getElementById('task5-finish').classList.remove('hidden');
  }
  if (pcbuLives === 0) {
    alert('Out of lives! Restart Task 5 to try again.');
    showTask(5);
  }
}

function lockCase (id) {
  document.querySelectorAll(`input[name="pcbu-${id}"]`)
          .forEach(el => el.disabled = true);
}

function updatePCBUHUD () {
  document.getElementById('pcbu-xp').textContent    = pcbuXP;
  document.getElementById('pcbu-lives').textContent = pcbuLives;
}

let gameState = {
  currentTask: 0,
  lives: 3,
  xp: 0,
  completedTasks: [],
  hazardsFound: [],
  attempts: {},
  currentHazardId: null,
  hazardDescriptions: {}
};

const hazards = {
  1: { name: "Unstable ladder placement",
       description: "The ladder is positioned at an unsafe angle near the apple tree" },
  2: { name: "Overhead power lines",
       description: "Electrical power lines run close to the orchard work area" },
  3: { name: "Unguarded machinery",
       description: "The tractor has exposed moving parts and no safety guards" },
  4: { name: "Wet/slippery ground",
       description: "The ground appears wet and muddy from irrigation" },
  5: { name: "Chemical storage",
       description: "Pesticide containers are stored in the work area" },
  6: { name: "Sharp pruning tools",
       description: "Cutting tools are left unsecured in the toolbox" },
  7: { name: "Noise from equipment",
       description: "The tractor and other machinery create high noise levels" },
  8: { name: "Manual handling",
       description: "Workers are lifting heavy apple crates without assistance" }
};

const controlMeasures = [
  { id: 'remove-hazard', text: 'Remove broken equipment', level: 'elimination' },
  { id: 'safer-chemical', text: 'Use less toxic pesticides', level: 'substitution' },
  { id: 'guard-machinery', text: 'Install machine guards', level: 'engineering' },
  { id: 'safety-training', text: 'Provide safety training', level: 'administrative' },
  { id: 'hearing-protection', text: 'Wear ear plugs', level: 'ppe' },
  { id: 'eliminate-climb', text: 'Use cherry picker instead of ladder', level: 'elimination' },
  { id: 'non-slip-surface', text: 'Install non-slip flooring', level: 'engineering' },
  { id: 'safety-gloves', text: 'Wear cut-resistant gloves', level: 'ppe' }
];

function startAssessment() {
  document.getElementById('welcome-screen').classList.add('hidden');
  showTask(1);
}

function showTask(taskNumber) {
  for (let i = 1; i <= 5; i++) {
    const el = document.getElementById(`task${i}`);
    if (el) el.classList.add('hidden');
  }
  document.getElementById(`task${taskNumber}`).classList.remove('hidden');
  gameState.currentTask = taskNumber;

  if (taskNumber === 1) initializeTask1();
  if (taskNumber === 2) initializeTask2();
  if (taskNumber === 4) initializeTask4();
  if (taskNumber === 5) initializeTask5();         
}

/* --------------  TASK 1 (Hazard Apples)  -------------- */
function initializeTask1() {
  document.querySelectorAll('.hazard-apple').forEach(apple => {
    apple.addEventListener('click', function() {
      const hazardId = this.dataset.hazard;
      if (!gameState.hazardsFound.includes(hazardId)) {
        openHazardModal(hazardId, this);
      }
    });
  });
}
function openHazardModal(hazardId, element) {
  gameState.currentHazardId = hazardId;
  gameState.currentHazardElement = element;

  const hazard = hazards[hazardId];
  document.getElementById('modal-hazard-title').textContent = hazard.name;
  document.getElementById('modal-hazard-description').textContent = hazard.description;
  document.getElementById('hazard-description-input').value = '';
  document.getElementById('hazard-modal').classList.remove('hidden');
}
function closeHazardModal() {
  document.getElementById('hazard-modal').classList.add('hidden');
  gameState.currentHazardId = null;
  gameState.currentHazardElement = null;
}
function submitHazardDescription() {
  const description = document.getElementById('hazard-description-input').value.trim();
  if (description.length < 10) {
    alert('Please provide a more detailed description (at least 10 characters).');
    return;
  }
  const hazardId = gameState.currentHazardId;
  const hazard = hazards[hazardId];

  gameState.hazardsFound.push(hazardId);
  gameState.hazardDescriptions[hazardId] = description;
  gameState.currentHazardElement.classList.add('found-apple');

  const hazardList = document.getElementById('hazard-list');
  const hazardDiv = document.createElement('div');
  hazardDiv.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4';
  hazardDiv.innerHTML = `
      <h4 class="font-semibold text-blue-800">🍎 ${hazard.name}</h4>
      <p class="text-sm text-blue-600 mb-2"><strong>Student Response:</strong> ${description}</p>
      <p class="text-xs text-gray-500">Submitted for teacher review</p>
  `;
  hazardList.appendChild(hazardDiv);

  document.getElementById('hazards-found').textContent = gameState.hazardsFound.length;

  if (gameState.hazardsFound.length === 8) {
    document.getElementById('task1-complete').classList.remove('hidden');
  }
  closeHazardModal();
}
function completeTask1() {
  gameState.completedTasks.push(1);
  updateProgress();
  showTask(2);
}

/* --------------  TASK 2 (Eliminate vs Minimise, exactly 3)  -------------- */
function initializeTask2() {
  // Build 3 empty response slots
  gameState.task2Responses = [
    { hazardId: '', choice: '', description: '' },
    { hazardId: '', choice: '', description: '' },
    { hazardId: '', choice: '', description: '' }
  ];

  const container = document.getElementById('t2-cards');
  container.innerHTML = '';

  // Options come from hazards found in Task 1; if empty, fall back to all hazards
  const availableIds = gameState.hazardsFound.length
    ? gameState.hazardsFound
    : Object.keys(hazards);

  const hazardOptionsHTML = availableIds.map(id =>
    `<option value="${id}">🍎 ${hazards[id].name}</option>`
  ).join('');

  for (let i = 0; i < 3; i++) {
    const card = document.createElement('div');
    card.className = 'rounded-xl border border-gray-200 p-4 bg-gray-50';
    card.innerHTML = `
      <div class="flex items-center justify-between">
        <h3 class="font-semibold text-gray-800">Card ${i + 1}</h3>
        <span id="t2-ok-${i}" class="hidden badge inline-flex items-center px-2 py-1 rounded-full text-xs bg-green-100 text-green-700">Ready</span>
      </div>

      <label class="block text-sm font-medium text-gray-700 mt-3 mb-1">Select a hazard</label>
      <select id="t2-h-${i}" class="w-full border border-gray-300 rounded-lg p-2 bg-white">
        <option value="">— choose —</option>
        ${hazardOptionsHTML}
      </select>

      <label class="block text-sm font-medium text-gray-700 mt-3 mb-1">Choose control type</label>
      <div class="grid grid-cols-2 gap-2">
        <button type="button" class="t2-choice btn-choice" data-slot="${i}" data-value="eliminate">🗑️ Eliminate</button>
        <button type="button" class="t2-choice btn-choice" data-slot="${i}" data-value="minimise">🛡️ Minimise</button>
      </div>

      <label class="block text-sm font-medium text-gray-700 mt-3 mb-1">Describe the control (one or two sentences)</label>
      <textarea id="t2-d-${i}" rows="3" class="w-full border border-gray-300 rounded-lg p-2" placeholder="e.g., Remove the broken ladder from service and use a cherry picker."></textarea>
      <p class="text-xs text-gray-500 mt-1">Minimum 12 characters.</p>
    `;
    container.appendChild(card);
  }

  // Style for choice buttons (mobile friendly)
  injectT2ChoiceStyles();

  // Wire up handlers
  document.querySelectorAll('.t2-choice').forEach(btn => {
    btn.addEventListener('click', () => {
      const slot = parseInt(btn.dataset.slot, 10);
      const val  = btn.dataset.value;
      setT2Choice(slot, val);
      validateT2();
    });
  });

  for (let i = 0; i < 3; i++) {
    document.getElementById(`t2-h-${i}`).addEventListener('change', validateT2);
    document.getElementById(`t2-d-${i}`).addEventListener('input', validateT2);
  }

  validateT2();
}

function setT2Choice(slot, value) {
  gameState.task2Responses[slot].choice = value;

  // Toggle visual active state
  const group = document.querySelectorAll(`.t2-choice[data-slot="${slot}"]`);
  group.forEach(b => b.classList.remove('active'));
  const picked = document.querySelector(`.t2-choice[data-slot="${slot}"][data-value="${value}"]`);
  if (picked) picked.classList.add('active');
}

function validateT2() {
  let complete = 0;

  for (let i = 0; i < 3; i++) {
    const hSel = document.getElementById(`t2-h-${i}`);
    const txt  = document.getElementById(`t2-d-${i}`);
    const ok   = document.getElementById(`t2-ok-${i}`);

    gameState.task2Responses[i].hazardId    = hSel.value;
    gameState.task2Responses[i].description = txt.value.trim();

    const good = hSel.value && gameState.task2Responses[i].choice &&
                 gameState.task2Responses[i].description.length >= 12;

    ok.classList.toggle('hidden', !good);
    if (good) complete++;
  }

  // Progress UI
  const pct = (complete / 3) * 100;
  document.getElementById('t2-progress').textContent = `${complete}/3`;
  document.getElementById('t2-bar').style.width = `${pct}%`;

  // Only show submit when all 3 are complete (exactly three; no extras exist)
  document.getElementById('task2-complete').classList.toggle('hidden', complete !== 3);
}

function completeTask2() {
  // Freeze inputs (summative)
  document.querySelectorAll('#t2-cards select, #t2-cards textarea, #t2-cards .t2-choice')
          .forEach(el => el.disabled = true);

  // Confirmation panel
  const conf = document.createElement('div');
  conf.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4 text-sm text-blue-700';
  conf.innerHTML = `✅ Your three Eliminate/Minimise decisions & descriptions have been recorded for teacher review.`;
  document.querySelector('#task2').appendChild(conf);

  if (!gameState.completedTasks.includes(2)) {
    gameState.completedTasks.push(2);
    updateProgress();
  }
  showTask(3);
}

function injectT2ChoiceStyles() {
  if (document.getElementById('t2-choice-style')) return;
  const s = document.createElement('style');
  s.id = 't2-choice-style';
  s.textContent = `
    .btn-choice {
      display:inline-flex;align-items:center;justify-content:center;
      border:2px solid #d1d5db;border-radius:.75rem;padding:.6rem .8rem;
      background:#fff;color:#1f2937;font-weight:600
    }
    .btn-choice.active { border-color:#16a34a;background:#dcfce7;color:#166534 }
    @media (max-width:640px){
      .btn-choice{ padding: .75rem .9rem; }
    }
  `;
  document.head.appendChild(s);
}

/* --------------  TASK 3 (Incident Form)  -------------- */
function checkTask3() {
  const formType       = document.querySelector('input[name="form-type"]:checked')?.value;
  const details        = Array.from(document.querySelectorAll('input[name="details"]:checked'))
                              .map(cb => cb.value);
  const notify         = document.querySelector('input[name="notify"]:checked')?.value;
  const worksafeTiming = document.querySelector('input[name="worksafe-timing"]:checked')?.value;

  if (!formType || !notify || !worksafeTiming) {
    alert('Please complete all questions before submitting.');
    return;
  }

  gameState.task3Responses = { formType, details, notify, worksafeTiming };

  document.getElementById('task3-complete').classList.remove('hidden');
  const conf = document.createElement('div');
  conf.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4';
  conf.innerHTML = `
    <h4 class="font-semibold text-blue-800">📝 Responses Submitted</h4>
    <p class="text-sm text-blue-600">
      Your incident reporting responses have been recorded for teacher review.
    </p>`;
  document.querySelector('#task3').appendChild(conf);
}
function completeTask3() {
  gameState.completedTasks.push(3);
  updateProgress();
  showTask(4);
}

/* --------------  TASK 4 (Emergency Sequence – mobile tap fallback)  -------------- */
function isSmallScreen(){ return window.matchMedia('(max-width: 640px)').matches; }

function initializeTask4() {
  // Enable drag on larger screens
  document.querySelectorAll('.emergency-step').forEach(step => {
    step.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', JSON.stringify({
        step: step.dataset.step, text: step.textContent.trim()
      }));
    });

    // Mobile: tap to place
    if (isSmallScreen()) {
      step.addEventListener('click', () => placeStepByTap(step));
      step.classList.add('ring-1','ring-blue-200','rounded-lg'); // larger tap target
    }
  });

  document.querySelectorAll('#emergency-sequence .drop-zone').forEach(zone => {
    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
    zone.addEventListener('drop', function(e) {
      e.preventDefault(); this.classList.remove('drag-over');
      const data = JSON.parse(e.dataTransfer.getData('text/plain'));
      this.innerHTML = `<div class="bg-blue-100 border border-blue-300 rounded p-2 text-sm">${data.text}</div>`;
      this.dataset.step = data.step;

      const original = document.querySelector(`#emergency-steps [data-step="${data.step}"]`);
      if (original && original.parentElement.id === 'emergency-steps') original.remove();
    });
  });
}

function nextEmptyDropZone(){
  return Array.from(document.querySelectorAll('#emergency-sequence .drop-zone'))
              .find(z => !z.dataset.step);
}

function placeStepByTap(stepEl) {
  const zone = nextEmptyDropZone();
  if (!zone) return; // all filled
  const text = stepEl.textContent.trim();
  const key  = stepEl.dataset.step;
  zone.innerHTML = `<div class="bg-blue-100 border border-blue-300 rounded p-2 text-sm">${text}</div>`;
  zone.dataset.step = key;
  // remove from source
  if (stepEl.parentElement?.id === 'emergency-steps') stepEl.remove();
}

function clearEmergencySequence() {
  // move placed items back to the source list
  const source = document.getElementById('emergency-steps');
  document.querySelectorAll('#emergency-sequence .drop-zone').forEach(zone => {
    if (zone.dataset.step) {
      const txt = zone.textContent.trim();
      const key = zone.dataset.step;
      const div = document.createElement('div');
      div.className = 'emergency-step bg-blue-100 border border-blue-300 rounded-lg p-3 cursor-move';
      div.setAttribute('draggable', 'true');
      div.dataset.step = key;
      div.textContent = txt;
      // reattach handlers
      div.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', JSON.stringify({ step: key, text: txt }));
      });
      if (isSmallScreen()) div.addEventListener('click', () => placeStepByTap(div));
      source.appendChild(div);
    }
    zone.textContent = `Step ${zone.getAttribute('data-position')}: Drop here`;
    delete zone.dataset.step;
  });
}
function checkTask4() {
  const order = [];
  document.querySelectorAll('#emergency-sequence .drop-zone').forEach(zone => {
    if (zone.dataset.step) order.push(zone.dataset.step);
  });
  if (order.length < 6) {
    alert('Please place all 6 emergency steps in order before submitting.');
    return;
  }
  // record for summary
  gameState.task4Sequence = order;

  // show complete button & confirmation
  document.getElementById('task4-complete').classList.remove('hidden');
  const conf = document.createElement('div');
  conf.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4';
  conf.innerHTML = `
    <h4 class="font-semibold text-blue-800">🚨 Emergency Sequence Submitted</h4>
    <p class="text-sm text-blue-600">Your emergency procedure sequence has been recorded for teacher review.</p>`;
  document.querySelector('#task4').appendChild(conf);
}

function completeTask4() {
  if (!gameState.completedTasks.includes(4)) {
    gameState.completedTasks.push(4);
    updateProgress();
  }
  showTask(5);
}
// Court verdict system
const TOTAL_REQUIRED = 2;   // ← only change needed if you add/remove cases later
const courtVerdicts = {};

// Override the earlier initializeTask5 to avoid errors (your Task 5 cases are static in the HTML)
function initializeTask5() {
  // No-op; keep HUD in sync if those elements exist
  updatePCBUHUD();
}

// Safe HUD updater (handles missing #pcbu-xp / #pcbu-lives gracefully)
function updatePCBUHUD () {
  const xpEl = document.getElementById('pcbu-xp');
  const livesEl = document.getElementById('pcbu-lives');
  if (xpEl)   xpEl.textContent    = pcbuXP;
  if (livesEl) livesEl.textContent = pcbuLives;
}

function deliverVerdict(caseNumber, verdict) {
  // Prevent double-submission on the same case
  if (courtVerdicts[caseNumber]) return;

  const reasoningEl = document.getElementById(`case${caseNumber}-reasoning`);
  const reasoning = reasoningEl ? reasoningEl.value.trim() : '';
  if (reasoning.length < 5) {
    alert('Please provide detailed judicial reasoning before delivering your verdict.');
    return;
  }

  // Store verdict and reasoning
  courtVerdicts[caseNumber] = { verdict, reasoning };

  // Update case UI
  const caseCard = document.getElementById(`case${caseNumber}`);
  if (!caseCard) return;

  const statusElement = caseCard.querySelector('.case-status');
  const verdictSection = caseCard.querySelector('.verdict-section');

  if (statusElement) {
    if (verdict === 'guilty') {
      statusElement.className = 'case-status bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium';
      statusElement.textContent = '⚖️ GUILTY';
      caseCard.className = 'case-card border-2 border-red-400 rounded-xl p-6 transition-all duration-300 bg-red-50';
    } else {
      statusElement.className = 'case-status bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium';
      statusElement.textContent = '⚖️ NOT GUILTY';
      caseCard.className = 'case-card border-2 border-green-400 rounded-xl p-6 transition-all duration-300 bg-green-50';
    }
  }

  if (verdictSection) {
    verdictSection.innerHTML = `
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <h5 class="font-semibold text-blue-800 mb-2">📜 Verdict Delivered</h5>
        <p class="text-blue-700 text-sm"><strong>Decision:</strong> ${verdict.toUpperCase()}</p>
        <p class="text-blue-700 text-sm"><strong>Reasoning:</strong> ${reasoning}</p>
        <p class="text-xs text-blue-600 mt-2">✅ Submitted for teacher review</p>
      </div>
    `;
  }

  updateCourtProgress();

  // Check if all required verdicts delivered
  const delivered = Object.keys(courtVerdicts).length;
  if (delivered >= TOTAL_REQUIRED) {
    const doneBtn = document.getElementById('task5-complete');
    if (doneBtn) doneBtn.classList.remove('hidden');

    // Final court summary
    const casesWrapper = document.getElementById('court-cases');
    if (casesWrapper && !document.getElementById('court-summary')) {
      const summaryDiv = document.createElement('div');
      summaryDiv.id = 'court-summary';
      summaryDiv.className = 'bg-amber-50 border-2 border-amber-300 rounded-xl p-6 mt-6';
      summaryDiv.innerHTML = `
        <div class="text-center">
          <div class="text-4xl mb-3">⚖️</div>
          <h3 class="text-xl font-bold text-amber-800 mb-2">Court Session Complete!</h3>
          <p class="text-amber-700">All ${TOTAL_REQUIRED} cases have been reviewed and verdicts delivered. Your judicial decisions demonstrate understanding of PCBU duties under the Health & Safety at Work Act 2015.</p>
        </div>
      `;
      casesWrapper.appendChild(summaryDiv);
    }
  }
}

function updateCourtProgress() {
  const count = Object.keys(courtVerdicts).length;
  const reviewed = document.getElementById('cases-reviewed');
  const delivered = document.getElementById('verdicts-delivered');
  if (reviewed)  reviewed.textContent = count;
  if (delivered) delivered.textContent = count;
}

function completeTask5() {
  if (!gameState.completedTasks.includes(5)) {
    gameState.completedTasks.push(5);
  }
  updateProgress();
  showCompletionScreen();
}

function showCompletionScreen() {
  // Hide tasks if they exist
  for (let i = 1; i <= 5; i++) {
    const el = document.getElementById(`task${i}`);
    if (el) el.classList.add('hidden');
  }

  // Create completion screen if missing
  let done = document.getElementById('completion-screen');
  if (!done) {
    done = document.createElement('section');
    done.id = 'completion-screen';
    done.className = 'bg-white rounded-xl shadow-lg p-6 text-center';
    done.innerHTML = `
      <h2 class="text-2xl font-bold text-gray-900 mb-2">✅ Assessment Submitted</h2>
      <p class="text-gray-700 mb-4">Your responses have been recorded for teacher review.</p>
      <button onclick="downloadSummary()"
              class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg">
        Download Summary
      </button>
    `;
    const main = document.querySelector('main') || document.body;
    main.appendChild(done);
  }
  done.classList.remove('hidden');
}

function updateProgress() {
  const progress = (gameState.completedTasks.length / 5) * 100;
  const bar = document.getElementById('progress-bar');
  const label = document.getElementById('progress-text');
  if (bar)   bar.style.width = `${progress}%`;
  if (label) label.textContent = `${gameState.completedTasks.length}/5 Tasks Complete`;
}

function downloadSummary () {
  let txt = `
HEALTH & SAFETY AT WORK ACT 2015 - STUDENT ASSESSMENT RESPONSES
Date: ${new Date().toLocaleDateString()}
Time: ${new Date().toLocaleTimeString()}

STUDENT RESPONSES FOR TEACHER REVIEW:\n\n`;

  // ── Task 1
  txt += 'TASK 1: HAZARD IDENTIFICATION\n';
  Object.keys(gameState.hazardDescriptions).forEach(id => {
    txt += `Hazard ${id}: ${hazards[id].name}
Student Description: ${gameState.hazardDescriptions[id]}\n`;
  });

  // ── Task 2 (Eliminate vs Minimise)
  txt += '\nTASK 2: ELIMINATE vs MINIMISE (3 required)\n';
  if (gameState.task2Responses) {
    gameState.task2Responses.forEach((r, idx) => {
      if (r.hazardId) {
        txt += `Card ${idx + 1}: Hazard ${r.hazardId} - ${hazards[r.hazardId].name}
Type: ${r.choice.toUpperCase()}
Description: ${r.description}\n`;
      }
    });
  }

  // ── Task 3
  txt += '\nTASK 3: INCIDENT REPORTING\n';
  if (gameState.task3Responses) {
    const r = gameState.task3Responses;
    txt += `Form Type: ${r.formType}
Details: ${r.details.join(', ')}
Notify: ${r.notify}
WorkSafe Timing: ${r.worksafeTiming}\n`;
  }

  // ── Task 4
  txt += '\nTASK 4: EMERGENCY PROCEDURES\n';
  if (gameState.task4Sequence) {
    txt += gameState.task4Sequence.map((s, i) => `${i + 1}. ${s}`).join('\n') + '\n';
  }

  // ── Task 5
  txt += '\nTASK 5: COURT VERDICTS\n';
  Object.keys(courtVerdicts).forEach(num => {
    const v = courtVerdicts[num];
    txt += `Case ${num}: ${v.verdict.toUpperCase()}
Reasoning: ${v.reasoning}\n`;
  });

  txt += '\nASSESSMENT STATUS: SUBMITTED FOR TEACHER REVIEW';

  const blob = new Blob([txt], { type: 'text/plain' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url;
  a.download = 'Student_Health_Safety_Assessment_Responses.txt';
  a.click();
  URL.revokeObjectURL(url);
}
</script>

<!-- Accessibility: TTS + STT helpers (kept, moved before </body>) -->
<script>
/* -----------------------------------------------------------------
   1.  CONFIG
------------------------------------------------------------------*/
const SPEECH_LANG   = 'en-NZ';      // change if you need a different locale
const EAR_BTN_HTML  = '<i class="fa-solid fa-ear-listen"></i>';
const MIC_BTN_HTML  = '<i class="fa-solid fa-microphone"></i>';
const READABLE_SEL  = 'h1,h2,h3,h4,h5,h6,p,li,label,th,td,blockquote';

/* -----------------------------------------------------------------
   2.  TEXT-TO-SPEECH helpers
------------------------------------------------------------------*/
let preferredVoice = null;
const preferredVoiceNames = [
  'Google UK English Female','Google UK English Male',
  'Google US English','Microsoft David - English (United States)',
  'Microsoft Zira - English (United States)'
];
function chooseVoice(){
  const voices = speechSynthesis.getVoices();
  for (const name of preferredVoiceNames){
    const v = voices.find(v=>v.name === name);
    if (v) return v;
  }
  return voices.find(v=>v.lang && v.lang.startsWith('en-')) || null;
}
function speak(text){
  if(!text.trim()) return;
  const u = new SpeechSynthesisUtterance(text);
  if(!preferredVoice) preferredVoice = chooseVoice();
  if(preferredVoice) u.voice = preferredVoice;
  u.lang    = SPEECH_LANG;
  u.rate    = .9;
  speechSynthesis.speak(u);
}

/* -----------------------------------------------------------------
   3.  SPEECH-TO-TEXT helpers
------------------------------------------------------------------*/
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognizer = null, activeTarget = null;

function startRecognizer(target){
  if(!SpeechRecognition) return;
  if(!recognizer){
    recognizer = new SpeechRecognition();
    recognizer.lang = SPEECH_LANG;
    recognizer.interimResults = true;
    recognizer.continuous = false;

    recognizer.onresult = e=>{
      const txt = Array.from(e.results).map(r=>r[0].transcript).join('');
      if(activeTarget){
        activeTarget.value = txt;
        activeTarget.scrollTop = activeTarget.scrollHeight;
      }
    };
    recognizer.onend   = stopAllMicBtns;
    recognizer.onerror = stopAllMicBtns;
  }
  activeTarget = target;
  try{ recognizer.start(); }catch(_){ /* double-start safety */ }
}
function stopRecognizer(){
  if(recognizer){
    try{ recognizer.stop(); }catch(_){}
  }
  activeTarget = null;
}
function stopAllMicBtns(){
  document.querySelectorAll('.mic-btn.recording')
          .forEach(b=>b.classList.remove('recording'));
  stopRecognizer();
}

/* -----------------------------------------------------------------
   4.  DOM ENHANCEMENT
------------------------------------------------------------------*/
function addEarButtons(root=document){
  root.querySelectorAll(READABLE_SEL).forEach(el=>{
    if(!el.textContent.trim()) return;
    if(el.nextElementSibling?.classList?.contains('ear-btn')) return;
    const btn = document.createElement('button');
    btn.type  = 'button';
    btn.className = 'ear-btn inline-flex items-center justify-center ml-1 text-blue-600';
    btn.innerHTML = EAR_BTN_HTML;
    btn.addEventListener('click',()=> speak(
      el.tagName === 'TEXTAREA' ? el.value : el.textContent
    ));
    el.insertAdjacentElement('afterend', btn);
  });
}

function addMicButtons(root=document){
  root.querySelectorAll('textarea,input[type="text"]:not([data-no-mic])')
      .forEach(el=>{
        if(el.nextElementSibling?.classList?.contains('mic-btn')) return;
        const btn = document.createElement('button');
        btn.type  = 'button';
        btn.className = 'mic-btn ml-2';
        btn.setAttribute('aria-label','Start voice input');
        btn.innerHTML = MIC_BTN_HTML;
        btn.addEventListener('click', e=>{
          const myself = e.currentTarget;
          if(myself.classList.contains('recording')){
            myself.classList.remove('recording');
            stopRecognizer();
          }else{
            stopAllMicBtns();
            myself.classList.add('recording');
            startRecognizer(el);
          }
        });
        el.insertAdjacentElement('afterend', btn);
      });
}

/* -----------------------------------------------------------------
   5.  INITIALISE + observe for late-added nodes (e.g. modals)
------------------------------------------------------------------*/
function enhance(root=document){
  addEarButtons(root);
  addMicButtons(root);
}

document.addEventListener('DOMContentLoaded',()=>{
  // 5.1  first pass
  enhance(document);

  // 5.2  watch for future additions (hazard modal, dynamic templates, etc.)
  const mo = new MutationObserver(muts=>{
    muts.forEach(m=>{
      m.addedNodes.forEach(node=>{
        if(node.nodeType === 1){   // element
          enhance(node);
        }
      });
    });
  });
  mo.observe(document.body,{childList:true,subtree:true});

  // 5.3  voice list may load asynchronously
  if(!speechSynthesis.getVoices().length){
    speechSynthesis.addEventListener('voiceschanged', ()=> preferredVoice = chooseVoice());
  }else{
    preferredVoice = chooseVoice();
  }

  // 5.4  Hide all mic buttons gracefully if SpeechRecognition missing
  if(!SpeechRecognition){
    document.querySelectorAll('.mic-btn').forEach(b=>b.style.display='none');
  }
});
</script>
</body>
</html>
