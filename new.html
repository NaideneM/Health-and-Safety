<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Safety Supervisor ChallengeÂ â€“ HealthÂ &Â Safety</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      crossorigin="anonymous" referrerpolicy="no-referrer">
  <style>
   /* ===== Base type & layout ===== */
@import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
html{ font-size:clamp(0.875rem,0.9rem+0.25vw,1.125rem); }
body{ font-family:'Inter',sans-serif; }
.safe-container{ max-width:90rem; margin-inline:auto; padding-inline:1rem; }

/* ===== Progress bar animation ===== */
.progress-bar{ transition:width .6s; }

/* ===== Task 1: Hazard apples ===== */
#orchard-scene{ overflow:hidden; }
.hazard-apple{
  position:absolute;
  width:7vw; max-width:35px; min-width:28px; aspect-ratio:1/1;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; font-size:28px;
  animation:sway 3s ease-in-out infinite;
  transition:transform .3s, filter .3s;
}
.hazard-apple:hover{ transform:scale(1.2); filter:brightness(1.2); }
@keyframes sway{ 0%,100%{transform:rotate(-2deg);} 50%{transform:rotate(2deg);} }
.found-apple{ animation:none !important; opacity:.5; }

/* ===== Generic modal wrapper (Task 1 & Task 2) ===== */
.hazard-modal{
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,.55); z-index:1000;
}

/* ===== A11y buttons (TTS / STT) ===== */
.mic-btn{
  display:inline-flex; align-items:center; justify-content:center;
  width:2.5rem; height:2.5rem; border-radius:.75rem;
  background:#e0f2fe; color:#0369a1; transition:background .3s;
}
.mic-btn:hover{ background:#bae6fd; }
.mic-btn.recording{ background:#fef08a; color:#92400e; }
.ear-btn{ background:none; border:0; padding:0; cursor:pointer; font-size:.9em; }
.ear-btn:hover{ color:#0369a1; }

/* ===== Image framing (modal & cards) ===== */
.square-img{
  aspect-ratio:1/1; width:100%; max-width:16rem; object-fit:contain;
  background:#f8fafc; border:1px solid #e5e7eb; border-radius:.5rem; padding:.5rem;
}
.square-thumb{
  aspect-ratio:1/1; width:4.5rem; object-fit:contain;
  background:#f8fafc; border:1px solid #bfdbfe; border-radius:.375rem; padding:.25rem;
}

/* ===== Task 2: Kiwifruit inside the crate ===== */
#t2-bin{
  background:url('images/harvest.png') center/cover no-repeat;
  height:56vw; max-height:440px; position:relative;
}
/* Mobile: keep full image visible so hotspot alignment stays true */
@media (max-width:640px){
  #t2-bin{
    background-size:contain;
    background-position:top center;
    height:auto;
    aspect-ratio:1440/960; /* set to your harvest.png ratio */
  }
}
/* Crate opening hotspot (buttons live inside this) */
#crate-hotspot{
  position:absolute;
  left:33.5%; top:20.5%; width:33%; height:45%;
  clip-path:polygon(6% 5%, 94% 12%, 92% 85%, 8% 78%);
  transform:perspective(900px) rotateX(14deg) rotateZ(-3deg);
  transform-origin:50% 0%;
  pointer-events:none;
}
#crate-hotspot > .fruit{ pointer-events:auto; }
/* Fruit buttons */
#t2-bin .fruit{
  position:absolute; transform:translate(-50%,-50%) scale(var(--depth,1));
  width:42px; height:42px; display:flex; align-items:center; justify-content:center;
  font-size:28px; background:transparent; border:0; cursor:pointer;
  filter:drop-shadow(0 2px 2px rgb(0 0 0 / .15));
  transition:transform .2s, opacity .2s;
}
#t2-bin .fruit:hover{ transform:translate(-50%,-50%) scale(calc(var(--depth,1)*1.1)); }
#t2-bin .fruit.used{ opacity:.35; pointer-events:none; }
/* Optional: front rim overlay (requires images/harvest-rim.png) */
#t2-bin::after{
  content:""; position:absolute; inset:0;
  background:url('images/harvest-rim.png') center/cover no-repeat;
  pointer-events:none;
}

/* ===== Task 4: Tap-to-order (summative, no feedback) ===== */
.t4-card{
  background:#eef2ff; border:2px solid #c7d2fe; border-radius:.75rem;
  padding:.75rem; font-size:.95rem; line-height:1.2; cursor:pointer;
  user-select:none; touch-action:manipulation;
}
.t4-card:active{ transform:scale(.98); }
.t4-slot{
  min-height:3.25rem; display:flex; align-items:center; justify-content:center;
  border:2px dashed #cbd5e1; border-radius:.75rem; background:#f8fafc; color:#64748b;
}
.t4-slot.filled{ border-style:solid; border-color:#94a3b8; background:#f1f5f9; color:#0f172a; }
  </style>
</head>

<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">

<header class="bg-white shadow-sm border-b-4 border-green-500">
  <div class="safe-container py-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div>
      <h1 class="text-[1.55rem] sm:text-2xl font-bold text-gray-900">
        ğŸ›¡ï¸ Safety Supervisor Challenge
      </h1>
      <p class="text-sm sm:text-base text-gray-600">
        HealthÂ &Â Safety at Work ActÂ 2015 â€“ PrimaryÂ Industry Assessment
      </p>
    </div>
    <div class="flex items-center justify-center">
      <div class="text-center">
        <div class="text-2xl font-bold text-blue-600">ğŸ“</div>
        <div class="text-xs text-gray-500">Assessment</div>
      </div>
    </div>
  </div>
  <!-- Progress -->
  <div class="safe-container">
    <div class="mt-2 flex justify-between text-xs sm:text-sm text-gray-600">
      <span>Progress</span><span id="progress-text">0/5Â TasksÂ Complete</span>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-3">
      <div id="progress-bar"
           class="progress-bar bg-gradient-to-r from-green-500 to-blue-500 h-3 rounded-full"
           style="width:0%"></div>
    </div>
  </div>
</header>
<main class="safe-container py-8">
  <!-- ========== WELCOME ========== -->
  <section id="welcome-screen"
           class="bg-white rounded-xl shadow-lg p-6 sm:p-8 text-center space-y-6">
    <div class="text-6xl">ğŸ</div>
    <h2 class="text-[1.75rem] font-bold text-gray-900">
      Welcome to Hei Whanake Orchard!
    </h2>
    <p class="text-gray-600">
      You're the Safety Supervisor for the day during our busy harvest season.
      Your mission: ensure our workplace meets all
      <span class="font-semibold">HealthÂ &Â Safety at Work ActÂ 2015</span> requirements!
    </p>

    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 text-left rounded-md">
      <h3 class="font-semibold text-yellow-800 mb-2">Your Tasks Today:</h3>
      <ul class="text-yellow-700 space-y-1">
        <li>ğŸ” <strong>HazardÂ Hunt:</strong> FindÂ 8 hazards in our orchard scene</li>
        <li>ğŸ¯ <strong>Riskâ€‘Buster:</strong> Match controls to hazards</li>
        <li>ğŸ“‹ <strong>AccidentÂ Log:</strong> Complete incident reporting</li>
        <li>ğŸš¨ <strong>EmergencyÂ Dash:</strong> Handle an emergency</li>
        <li>âš–ï¸ <strong>PCBU DutyÂ Check:</strong> Evaluate dutyâ€‘ofâ€‘care cases</li>
      </ul>
    </div>
    <button onclick="startAssessment()"
            class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg
                   text-lg transition-colors">
      StartÂ YourÂ ShiftÂ ğŸš€
    </button>
  </section>
<!-- ========== TASK 1 â€“ HAZARD HUNT ========== -->
<section id="task1"
         class="hidden bg-white rounded-xl shadow-lg p-4 sm:p-6 space-y-6">

  <!-- header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
    <h2 class="text-xl sm:text-2xl font-bold text-gray-900">
      ğŸ” Task 1 â€“ Hazard Hunt
    </h2>
    <span class="text-sm text-gray-600">
      Found: <span id="hazards-found">0</span>/8
    </span>
  </div>

  <p class="text-gray-600">
    Tap the apples ğŸ in the orchard to identify hazards.
    For each hazard, describe what injury or illness it could cause.
  </p>

  <!-- orchard scene -->
  <div id="orchard-scene"
       class="relative rounded-lg bg-center bg-cover mx-auto"
       style="background-image:url('images/orchard.jpg');height:60vw;max-height:500px;">

    <!-- positions converted to % of 640Ã—500 reference -->
    <div class="hazard-apple" style="top:24%; left:18.75%;" data-hazard="1">ğŸ</div>
    <div class="hazard-apple" style="top:20%; left:31.25%;" data-hazard="2">ğŸ</div>
    <div class="hazard-apple" style="top:32%; left:50%;"   data-hazard="3">ğŸ</div>
    <div class="hazard-apple" style="top:24%; left:71.875%;" data-hazard="4">ğŸ</div>
    <div class="hazard-apple" style="top:16%; left:87.5%;"  data-hazard="5">ğŸ</div>
    <div class="hazard-apple" style="top:30%; left:54.69%;" data-hazard="6">ğŸ</div>
    <div class="hazard-apple" style="top:12%; left:14.06%;" data-hazard="7">ğŸ</div>
    <div class="hazard-apple" style="top:36%; left:35.94%;" data-hazard="8">ğŸ</div>
  </div>

  <!-- hazard modal (now shows an IMAGE instead of a description) -->
  <div id="hazard-modal" class="hazard-modal hidden">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-[90vw] max-w-md mx-2 space-y-4">
      <div class="text-center space-y-1">
        <div class="text-4xl">âš ï¸</div>
        <h3 id="modal-hazard-title" class="text-lg font-bold text-gray-900">
          Hazard Identified!
        </h3>
      </div>

      <!-- NEW: image placeholder -->
<img id="modal-hazard-image"
     src=""
     alt=""
     class="square-img mx-auto" />

      <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded-md">
        <p class="text-sm text-yellow-800">
          <strong>Your task:</strong>
          Describe the potential injury or illness this hazard could cause.
        </p>
      </div>

      <!-- textarea gets real-time STT -->
      <label for="hazard-description-input"
             class="block text-sm font-medium text-gray-700 mb-1">
        Describe the injury or illness:
      </label>
      <div class="flex items-start gap-2">
        <textarea id="hazard-description-input"
                  class="flex-1 p-3 border border-gray-300 rounded-lg speech-enabled"
                  rows="3"
                  placeholder="e.g., Falls from height could cause fracturesâ€¦"></textarea>
      </div>

      <div class="flex gap-3 pt-2">
        <button onclick="submitHazardDescription()"
                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-lg">
          Submit âœ…
        </button>
        <button onclick="closeHazardModal()"
                class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 rounded-lg">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- list container & task complete -->
  <div id="hazard-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>

  <button id="task1-complete" onclick="completeTask1()"
          class="hidden bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg">
    Complete Hazard Hunt âœ…
  </button>
</section>
 
   <!-- TASK 2 â€“ Merged NZQA-compliant version (click 3 fruit -> collect minimise & eliminate) -->
<section id="task2" class="hidden bg-white rounded-xl shadow-lg p-4 sm:p-6 space-y-6">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
    <h2 class="text-xl sm:text-2xl font-bold text-gray-900">ğŸ¥ Task 2 â€“ Hazard Control Measures</h2>
    <div class="text-sm text-gray-600">Completed: <span id="t2-count">0</span>/3</div>
  </div>
  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm">
    <p class="text-blue-800"><strong>Objective:</strong> Click <strong>three kiwifruit</strong> in the image below to reveal hazards. For each hazard, describe <strong>both</strong> how to <em>minimise</em> and <em>eliminate</em> the risk. <em>No instant feedback</em> â€“ your assessor will review your responses.</p>
  </div>
  <div>
    <label class="block text-sm font-medium text-gray-700 mb-2">1) Click three different kiwifruit:</label>
    <div id="t2-bin" class="rounded-lg overflow-hidden border bg-white">
      <div id="crate-hotspot" aria-label="Crate hotspot"></div>
    </div>
    <p class="text-xs text-gray-500 mt-2">Each click reveals a random hazard image and a form to enter <strong>Minimise</strong> and <strong>Eliminate</strong> strategies.</p>
  </div>
  <div id="t2-responses" class="grid grid-cols-1 gap-3"></div>
  <button id="task2-complete" class="hidden bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg">Complete Task 2 âœ…</button>
</section>

<!-- Task 3: Accident Log Mini-Sim -->
<div id="task3" class="hidden bg-white rounded-xl shadow-lg p-6 mb-8">
  <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ“‹ Task 3: Accident Log Mini-Sim</h2>

  <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
    <h3 class="font-semibold text-red-800 mb-2">âš ï¸ Incident Report</h3>
    <p class="text-red-700">A worker has slipped on wet concrete near the pack house and twisted their ankle. They can walk but are in pain. Complete the formal reporting process.</p>
  </div>

  <div class="space-y-6">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">1. Choose 1 of the processes that should be done:</label>
      <div class="space-y-2">
        <label class="flex items-center">
          <input type="radio" name="form-type" value="incident" class="mr-2">
          <span>Incident/Accident Report Form</span>
        </label>
        <label class="flex items-center">
          <input type="radio" name="form-type" value="hazard" class="mr-2">
          <span>Hazard Report Form</span>
        </label>
        <label class="flex items-center">
          <input type="radio" name="form-type" value="inspection" class="mr-2">
          <span>Safety Inspection Form</span>
        </label>
      </div>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">2. Key details to record (select all that apply):</label>
      <div class="space-y-2">
        <label class="flex items-center">
          <input type="checkbox" name="details" value="time-date" class="mr-2">
          <span>Time and date of incident</span>
        </label>
        <label class="flex items-center">
          <input type="checkbox" name="details" value="location" class="mr-2">
          <span>Exact location where incident occurred</span>
        </label>
        <label class="flex items-center">
          <input type="checkbox" name="details" value="witnesses" class="mr-2">
          <span>Names of witnesses</span>
        </label>
        <label class="flex items-center">
          <input type="checkbox" name="details" value="weather" class="mr-2">
          <span>Weather conditions</span>
        </label>
        <label class="flex items-center">
          <input type="checkbox" name="details" value="injury" class="mr-2">
          <span>Nature and extent of injury</span>
        </label>
      </div>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">3. Who must be notified immediately?</label>
      <div class="space-y-2">
        <label class="flex items-center">
          <input type="radio" name="notify" value="worksafe" class="mr-2">
          <span>WorkSafe New Zealand only</span>
        </label>
        <label class="flex items-center">
          <input type="radio" name="notify" value="supervisor" class="mr-2">
          <span>Immediate supervisor/manager</span>
        </label>
        <label class="flex items-center">
          <input type="radio" name="notify" value="police" class="mr-2">
          <span>New Zealand Police</span>
        </label>
      </div>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">4. When must WorkSafe NZ be notified for this type of incident?</label>
      <div class="space-y-2">
        <label class="flex items-center">
          <input type="radio" name="worksafe-timing" value="immediately" class="mr-2">
          <span>Immediately (this is a notifiable incident)</span>
        </label>
        <label class="flex items-center">
          <input type="radio" name="worksafe-timing" value="48hours" class="mr-2">
          <span>Within 48 hours</span>
        </label>
        <label class="flex items-center">
          <input type="radio" name="worksafe-timing" value="not-required" class="mr-2">
          <span>Not required for this incident</span>
        </label>
      </div>
    </div>
  </div>

  <button onclick="checkTask3()" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">
    Submit Report ğŸ“
  </button>

  <button id="task3-complete" onclick="completeTask3()" class="hidden mt-4 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg">
    Complete Accident Log âœ…
  </button>
</div>

<!-- Task 4: Emergency Dash -->
<div class="hidden bg-white rounded-xl shadow-lg p-6 mb-8" id="task4">

  <h2 class="text-2xl font-bold text-gray-900 mb-4">ğŸš¨ Task 4: Emergency Dash</h2>

  <p class="text-sm text-gray-600 mb-4">Tap the steps to place them in order (1â€“6). You can undo or clear if you change your mind.</p>

  <div class="grid md:grid-cols-2 gap-4">
    <!-- pool -->
    <div>
      <h4 class="font-medium text-gray-800 mb-2">Emergency Steps</h4>
      <div id="t4-pool" class="grid grid-cols-1 gap-2"></div>
    </div>

    <!-- sequence -->
    <div>
      <h4 class="font-medium text-gray-800 mb-2">Your Order</h4>
      <div id="t4-slots" class="grid grid-cols-1 gap-2"></div>

      <div class="flex flex-wrap gap-2 mt-3">
        <button type="button" class="px-3 py-2 rounded-lg border" onclick="t4Undo()">â†©ï¸ Undo</button>
        <button type="button" class="px-3 py-2 rounded-lg border" onclick="t4Clear()">ğŸ§¹ Clear</button>
        <button type="button" class="px-3 py-2 rounded-lg border" onclick="t4Shuffle()">ğŸ”€ Shuffle</button>
      </div>
    </div>
  </div>

  <button id="task4-complete" onclick="completeTask4()"
          class="hidden mt-6 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg">
    Complete Emergency Dash âœ…
  </button>
</div>

<!-- Task 5: Safety Court Simulation -->
<div id="task5" class="hidden bg-white rounded-xl shadow-lg p-6 mb-8">
  <div class="text-center mb-6">
    <div class="text-6xl mb-4">âš–ï¸</div>
    <h2 class="text-3xl font-bold text-gray-900 mb-2">Safety Court: Judge's Chamber</h2>
    <p class="text-lg text-gray-600">You are the presiding judge in the Health & Safety Court. Review each case and deliver your verdict!</p>
    <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mt-4">
      <p class="text-amber-800 font-medium">âš–ï¸ Cases Reviewed: <span id="cases-reviewed">0</span>/2 | Verdicts Delivered: <span id="verdicts-delivered">0</span>/2</p>
    </div>
  </div>

  <!-- Court Cases -->
  <div id="court-cases" class="space-y-6">
    <!-- Case 1 -->
    <div id="case1" class="case-card border-2 border-gray-300 rounded-xl p-6 transition-all duration-300 hover:shadow-lg">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-gray-900">ğŸ“‹ Case #001: Kiwi Orchard Ltd</h3>
        <div class="case-status bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium">
          Under Review
        </div>
      </div>

      <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-4">
        <h4 class="font-semibold text-red-800 mb-2">âš ï¸ Charges: Inadequate Worker Training & Supervision</h4>
        <p class="text-red-700 text-sm"><strong>Evidence:</strong> Kiwi Orchard Ltd hired 5 new seasonal workers. They received only a 10-minute safety briefing, basic PPE, and were assigned to work with experienced pickers. No formal training records were kept, and there was no ongoing supervision during the busy harvest period.</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h5 class="font-semibold text-blue-800 mb-2">ğŸ›¡ï¸ Defense Arguments:</h5>
          <ul class="text-blue-700 text-sm space-y-1">
            <li>â€¢ Provided safety briefing on first day</li>
            <li>â€¢ Supplied basic PPE (glasses & gloves)</li>
            <li>â€¢ Paired new workers with experienced staff</li>
            <li>â€¢ Busy harvest season - limited time</li>
          </ul>
        </div>

        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
          <h5 class="font-semibold text-purple-800 mb-2">âš–ï¸ HSWA 2015 Requirements:</h5>
          <ul class="text-purple-700 text-sm space-y-1">
            <li>â€¢ Adequate training & supervision</li>
            <li>â€¢ Formal training records</li>
            <li>â€¢ Ongoing safety monitoring</li>
            <li>â€¢ Competency verification</li>
          </ul>
        </div>
      </div>

      <div class="verdict-section bg-gray-50 rounded-lg p-4">
        <h5 class="font-semibold text-gray-800 mb-3">ğŸ‘¨â€âš–ï¸ Your Verdict:</h5>
        <div class="space-y-3">
          <div class="flex space-x-4">
            <button onclick="deliverVerdict(1, 'guilty')" class="verdict-btn flex-1 bg-red-100 hover:bg-red-200 border-2 border-red-300 text-red-800 font-semibold py-3 px-4 rounded-lg transition-all">
              âš–ï¸ GUILTY - PCBU Failed Duty
            </button>
            <button onclick="deliverVerdict(1, 'not-guilty')" class="verdict-btn flex-1 bg-green-100 hover:bg-green-200 border-2 border-green-300 text-green-800 font-semibold py-3 px-4 rounded-lg transition-all">
              âš–ï¸ NOT GUILTY - Duty Met
            </button>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ Judicial Reasoning (required):</label>
            <textarea id="case1-reasoning" class="w-full p-3 border border-gray-300 rounded-lg" rows="2" placeholder="Explain your legal reasoning based on HSWA 2015 requirements..."></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Case 2 -->
    <div id="case2" class="case-card border-2 border-gray-300 rounded-xl p-6 transition-all duration-300 hover:shadow-lg">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-gray-900">ğŸ“‹ Case #002: Apple Valley Orchards</h3>
        <div class="case-status bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium">
          Under Review
        </div>
      </div>

      <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
        <h4 class="font-semibold text-blue-800 mb-2">ğŸ” Charges: Questioned Safety Management System</h4>
        <p class="text-blue-700 text-sm"><strong>Evidence:</strong> Apple Valley Orchards conducts monthly safety inspections and maintains a hazard register. When workers reported a broken ladder, it was immediately removed and replaced within 24 hours. The company provides comprehensive training, regular toolbox talks, and has clear hazard reporting procedures. All incidents are investigated with corrective actions implemented.</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <h5 class="font-semibold text-green-800 mb-2">âœ… Evidence of Compliance:</h5>
          <ul class="text-green-700 text-sm space-y-1">
            <li>â€¢ Monthly safety inspections</li>
            <li>â€¢ Maintained hazard register</li>
            <li>â€¢ Immediate hazard response (24hrs)</li>
            <li>â€¢ Comprehensive training program</li>
            <li>â€¢ Regular toolbox talks</li>
            <li>â€¢ Clear reporting procedures</li>
            <li>â€¢ Incident investigation system</li>
          </ul>
        </div>

        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
          <h5 class="font-semibold text-orange-800 mb-2">âš ï¸ Prosecution Claims:</h5>
          <ul class="text-orange-700 text-sm space-y-1">
            <li>â€¢ Equipment still broke despite inspections</li>
            <li>â€¢ Should have prevented ladder failure</li>
            <li>â€¢ Reactive rather than proactive</li>
            <li>â€¢ Workers were exposed to risk</li>
          </ul>
        </div>
      </div>

      <div class="verdict-section bg-gray-50 rounded-lg p-4">
        <h5 class="font-semibold text-gray-800 mb-3">ğŸ‘¨â€âš–ï¸ Your Verdict:</h5>
        <div class="space-y-3">
          <div class="flex space-x-4">
            <button onclick="deliverVerdict(2, 'guilty')" class="verdict-btn flex-1 bg-red-100 hover:bg-red-200 border-2 border-red-300 text-red-800 font-semibold py-3 px-4 rounded-lg transition-all">
              âš–ï¸ GUILTY - PCBU Failed Duty
            </button>
            <button onclick="deliverVerdict(2, 'not-guilty')" class="verdict-btn flex-1 bg-green-100 hover:bg-green-200 border-2 border-green-300 text-green-800 font-semibold py-3 px-4 rounded-lg transition-all">
              âš–ï¸ NOT GUILTY - Duty Met
            </button>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ Judicial Reasoning (required):</label>
            <textarea id="case2-reasoning" class="w-full p-3 border border-gray-300 rounded-lg" rows="2" placeholder="Explain your legal reasoning based on HSWA 2015 requirements..."></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="text-center mt-8">
    <button id="task5-complete" onclick="completeTask5()" class="hidden bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg text-lg">
      ğŸ“œ Court Session Complete - Submit Verdicts âš–ï¸
    </button>
  </div>
</div>

<!-- Task 2 response modal (collects BOTH minimise & eliminate) -->
<div id="t2-modal" class="hazard-modal hidden" role="dialog" aria-modal="true" aria-labelledby="t2-modal-title">
  <div class="bg-white rounded-xl shadow-2xl p-6 w-[92vw] max-w-2xl mx-2 space-y-4">
    <div class="flex items-center justify-between">
      <div class="space-y-1">
        <h3 id="t2-modal-title" class="text-lg font-bold text-gray-900">Hazard</h3>
        <p class="text-xs text-gray-500">Provide <strong>both</strong> control strategies.</p>
      </div>
      <button type="button" id="t2-close" class="px-3 py-1 rounded-lg border">âœ–</button>
    </div>
    <div class="flex items-start gap-4">
      <img id="t2-modal-img" src="" alt="" class="square-img" />
      <div class="flex-1 grid grid-cols-1 gap-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Minimise â€“ how to reduce the risk</label>
          <textarea id="t2-minimise" rows="3" class="w-full border border-gray-300 rounded-lg p-2" placeholder="e.g., Use non-slip mats and schedule rest breaks to reduce fatigue."></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Eliminate â€“ how to remove the risk completely</label>
          <textarea id="t2-eliminate" rows="3" class="w-full border border-gray-300 rounded-lg p-2" placeholder="e.g., Remove damaged ladders from service and use a cherry picker."></textarea>
        </div>
      </div>
    </div>
    <div class="flex gap-3 pt-2">
      <button id="t2-save" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-lg">Save Response âœ…</button>
      <button id="t2-cancel" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 rounded-lg">Cancel</button>
    </div>
  </div>
</div>

<!--  MASTER GAME SCRIPT -->
<script>
const pcbuCases = [
  {
    id: 1,
    title: 'Training & Supervision',
    story: `Kiwi Orchard Ltd has hired five new seasonal workers for harvest.
            The manager gives them a 10-minute safety briefing on day one,
            hands out safety glasses and gloves, then assigns them to work
            with experienced pickers. No formal training records are kept and
            thereâ€™s no ongoing supervision during the busy period.`,
    options: [
      { value: 'yes', label: 'Yes â€“ basic briefing and PPE were provided' },
      { value: 'no',  label: 'No â€“ training, supervision and records are inadequate' }
    ],
    correct: 'no',
    feedbackRight: 'âœ… Correct â€“ PCBU failed to provide adequate training & supervision.',
    feedbackWrong: 'âŒ Not quite. A quick briefing and PPE alone arenâ€™t enough.'
  },
  {
    id: 2,
    title: 'Hazard Management',
    story: `Apple Valley Orchards conducts monthly safety inspections and keeps
            a hazard register. When workers report a broken ladder, it is
            removed from service and replaced within 24 hours. Comprehensive
            safety training, regular toolbox talks and clear reporting
            procedures are in place. All incidents are investigated and
            corrective actions implemented.`,
    options: [
      { value: 'yes', label: 'Yes â€“ systematic approach to hazard management' },
      { value: 'no',  label: 'No â€“ they should have prevented the ladder breaking' }
    ],
    correct: 'yes',
    feedbackRight: 'âœ… Spot on â€“ theyâ€™re meeting their duty through systematic hazard management.',
    feedbackWrong: 'âŒ Check again â€“ think about the steps they already took.'
  }
];

let pcbuXP   = 0;
let pcbuLives = 3;

function initializeTask5 () {
  pcbuXP   = 0;
  pcbuLives = 3;
  updatePCBUHUD();

  const wrapper = document.getElementById('pcbu-cases');
  if (!wrapper) return;            // guard if no dynamic container exists
  wrapper.innerHTML = '';

  pcbuCases.forEach(cs => {
    const card = document.createElement('div');
    card.className = 'border border-gray-200 rounded-lg p-4 bg-gray-50';
    card.innerHTML = `
      <h4 class="font-semibold text-gray-800 mb-2">${cs.title}</h4>
      <p class="text-gray-700 mb-4">${cs.story}</p>
      ${cs.options.map(opt => `
        <label class="flex items-center mb-1">
          <input type="radio" name="pcbu-${cs.id}" value="${opt.value}" class="mr-2">
          <span>${opt.label}</span>
        </label>`).join('')}
      <button onclick="judgeCase(${cs.id})"
              class="mt-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-1 px-3 rounded">
        Judge âš–ï¸
      </button>
      <div id="pcbu-feedback-${cs.id}" class="mt-2 text-sm"></div>
    `;
    wrapper.appendChild(card);
  });
}

function judgeCase (id) {
  const cs = pcbuCases.find(c => c.id === id);
  const chosen = document.querySelector(`input[name="pcbu-${id}"]:checked`);
  if (!chosen) { alert('Select an answer first!'); return; }

  const box = document.getElementById(`pcbu-feedback-${id}`);
  if (!box) return;

  if (chosen.value === cs.correct) {
    box.textContent = cs.feedbackRight;
    box.className   = 'mt-2 text-green-600';
    pcbuXP += 100;
    lockCase(id);
  } else {
    box.textContent = cs.feedbackWrong;
    box.className   = 'mt-2 text-red-600';
    pcbuLives -= 1;
  }

  updatePCBUHUD();

  if (pcbuXP === pcbuCases.length * 100) {
    const fin = document.getElementById('task5-finish');
    if (fin) fin.classList.remove('hidden');
  }
  if (pcbuLives === 0) {
    alert('Out of lives! Restart Task 5 to try again.');
  }
}

function lockCase (id) {
  document.querySelectorAll(`input[name="pcbu-${id}"]`)
          .forEach(el => el.disabled = true);
}

function updatePCBUHUD () {
  const xpEl = document.getElementById('pcbu-xp');
  const livesEl = document.getElementById('pcbu-lives');
  if (xpEl)   xpEl.textContent    = pcbuXP;
  if (livesEl) livesEl.textContent = pcbuLives;
}

let gameState = {
  currentTask: 0,
  lives: 3,
  xp: 0,
  completedTasks: [],
  hazardsFound: [],
  attempts: {},
  currentHazardId: null,
  hazardDescriptions: {}
};

const hazards = {
  1: { name: "hazard 1", img: "images/h1.png", alt: "h1" },
  2: { name: "hazard 2", img: "images/h2.png", alt: "h2" },
  3: { name: "hazard 3", img: "images/h3.png", alt: "h3" },
  4: { name: "hazard 4", img: "images/h4.png", alt: "h4" },
  5: { name: "hazard 5", img: "images/h5.png", alt: "h5" },
  6: { name: "hazard 6", img: "images/h6.png", alt: "h6" },
  7: { name: "hazard 7", img: "images/h7.png", alt: "h7" },
  8: { name: "hazard 8", img: "images/h8.png", alt: "h8" }
};

const controlMeasures = [
  { id: 'remove-hazard', text: 'Remove broken equipment', level: 'elimination' },
  { id: 'safer-chemical', text: 'Use less toxic pesticides', level: 'substitution' },
  { id: 'guard-machinery', text: 'Install machine guards', level: 'engineering' },
  { id: 'safety-training', text: 'Provide safety training', level: 'administrative' },
  { id: 'hearing-protection', text: 'Wear ear plugs', level: 'ppe' },
  { id: 'eliminate-climb', text: 'Use cherry picker instead of ladder', level: 'elimination' },
  { id: 'non-slip-surface', text: 'Install non-slip flooring', level: 'engineering' },
  { id: 'safety-gloves', text: 'Wear cut-resistant gloves', level: 'ppe' }
];

function startAssessment() {
  document.getElementById('welcome-screen').classList.add('hidden');
  showTask(1);
}

function showTask(taskNumber) {
  for (let i = 1; i <= 5; i++) {
    const el = document.getElementById(`task${i}`);
    if (el) el.classList.add('hidden');
  }

  const target = document.getElementById(`task${taskNumber}`);
  if (target) target.classList.remove('hidden');

  gameState.currentTask = taskNumber;

  if (taskNumber === 1) initializeTask1?.();
  if (taskNumber === 2) initializeTask2?.();
  if (taskNumber === 4) initializeTask4?.();
  if (taskNumber === 5) initializeTask5?.();
}

// helper used by Task 4 completion button (keeps flow consistent)
function completeTask4(){
  if (!gameState.completedTasks.includes(4)) gameState.completedTasks.push(4);
  updateProgress?.();
  showTask(5);
}
/* --------------  TASK 1 (Hazard Apples)  -------------- */
function initializeTask1() {
  document.querySelectorAll('.hazard-apple').forEach(apple => {
    apple.addEventListener('click', function() {
      const hazardId = this.dataset.hazard;
      if (!gameState.hazardsFound.includes(hazardId)) {
        openHazardModal(hazardId, this);
      }
    });
  });
}
function openHazardModal(hazardId, element) {
  gameState.currentHazardId = hazardId;
  gameState.currentHazardElement = element;

  const hazard = hazards[hazardId];
  document.getElementById('modal-hazard-title').textContent = hazard.name;

  // NEW: populate the image
  const img = document.getElementById('modal-hazard-image');
  if (img) {
    img.src = hazard.img;
    img.alt = hazard.alt || hazard.name;
  }

  // clear input & show modal
  document.getElementById('hazard-description-input').value = '';
  document.getElementById('hazard-modal').classList.remove('hidden');
}

function closeHazardModal() {
  document.getElementById('hazard-modal').classList.add('hidden');
  gameState.currentHazardId = null;
  gameState.currentHazardElement = null;
}
function submitHazardDescription() {
  const description = document.getElementById('hazard-description-input').value.trim();
  if (description.length < 1) {
    alert('Please provide a more detailed description.');
    return;
  }
  const hazardId = gameState.currentHazardId;
  const hazard = hazards[hazardId];

  gameState.hazardsFound.push(hazardId);
  gameState.hazardDescriptions[hazardId] = description;
  gameState.currentHazardElement.classList.add('found-apple');

  const hazardList = document.getElementById('hazard-list');
  const hazardDiv = document.createElement('div');
  hazardDiv.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4';
  hazardDiv.innerHTML = `
  <div class="flex items-start gap-3">
<img src="${hazard.img}" alt="${hazard.alt || hazard.name}"
     class="square-thumb">
    <div>
      <h4 class="font-semibold text-blue-800">ğŸ ${hazard.name}</h4>
      <p class="text-sm text-blue-600 mb-2"><strong>Student Response:</strong> ${description}</p>
      <p class="text-xs text-gray-500">Submitted for teacher review</p>
    </div>
  </div>
`;
  hazardList.appendChild(hazardDiv);

  document.getElementById('hazards-found').textContent = gameState.hazardsFound.length;

  if (gameState.hazardsFound.length === 8) {
    document.getElementById('task1-complete').classList.remove('hidden');
  }
  closeHazardModal();
}
function completeTask1() {
  gameState.completedTasks.push(1);
  updateProgress();
  showTask(2);
}

// Small helpers used by Task 2
const qs  = sel => document.querySelector(sel);
const qsa = sel => Array.from(document.querySelectorAll(sel));
const shuffle = (arr) => { const a = arr.slice(); for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };
const escapeHtml = (s) => { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; };

// === Task 2 config: exactly 3 random unique hazards from 8 PER RUN
const t2Config = { maxClicks: 3 };

// Ensure Task 2 state exists (and has a 3-item pre-picked set)
function ensureT2State(){
  if (!gameState.task2){
    gameState.task2 = {
      usedFruitIndexes: new Set(),
      responses: [],
      chosenHazards: [],
      roundHazards: shuffle([1,2,3,4,5,6,7,8]).slice(0,3), // <- the only 3 we will use
      pendingFruitIndex: null,
      pendingFruitBtn: null
    };
  }
  if (!gameState.task2.roundHazards || gameState.task2.roundHazards.length !== 3){
    gameState.task2.roundHazards = shuffle([1,2,3,4,5,6,7,8]).slice(0,3);
  }
}

function initializeTask2(){
  ensureT2State();
  placeFruitHotspots();
  updateT2Count();
}

function placeFruitHotspots(){
  const host = qs('#crate-hotspot'); if(!host) return;
  host.innerHTML = '';

  // positions are now % inside the crate opening
  const spots = [
    [18,18],[40,16],[70,20],
    [26,46],[53,50],[78,44],
    [22,72],[50,68],[75,70]
  ];

  const pickedSpots = shuffle(spots).slice(0,3);

  pickedSpots.forEach((p, idx) => {
    const [x, y] = p; // 0â€“100 within the hotspot box
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'fruit';
    b.style.left = x + '%';
    b.style.top  = y + '%';

    // fake depth: smaller at the back (yâ‰ˆ0), larger near the front (yâ‰ˆ100)
    const depth = 0.85 + (y/100)*0.35; // 0.85 â†’ 1.20
    b.style.setProperty('--depth', depth);

    b.setAttribute('aria-label','Pick kiwifruit');
    b.textContent = 'ğŸ¥';
    b.onclick = () => handleFruitClick(b, idx);

    if (gameState.task2.usedFruitIndexes.has(idx)) b.classList.add('used');

    host.appendChild(b);
  });
}

function handleFruitClick(btn, index){
  ensureT2State();
  if (gameState.task2.responses.length >= t2Config.maxClicks) return;
  if (gameState.task2.usedFruitIndexes.has(index)) return;

  // Show the next pre-picked hazard (0,1,2). We do NOT mutate the pool here.
  const nextIdx  = gameState.task2.responses.length; // 0..2
  const hazardId = gameState.task2.roundHazards[nextIdx];

  // Remember which fruit this attempt belongs to (mark used only on SAVE)
  gameState.task2.pendingFruitIndex = index;
  gameState.task2.pendingFruitBtn   = btn;

  openT2Modal(hazardId);
}

let currentHazardId = null;
function openT2Modal(hazardId){
  currentHazardId = hazardId;
  const h = hazards[hazardId];
  qs('#t2-modal-title').textContent = `Hazard: ${h.name}`;
  const img = qs('#t2-modal-img'); img.src = h.img; img.alt = h.alt || h.name;
  qs('#t2-minimise').value = '';
  qs('#t2-eliminate').value = '';
  qs('#t2-modal').classList.remove('hidden');
}

function closeT2Modal(){
  qs('#t2-modal').classList.add('hidden');
  currentHazardId = null;
}

// Wire modal buttons (replace existing listeners)
qs('#t2-close').addEventListener('click', ()=>{
  gameState.task2.pendingFruitIndex = null;
  gameState.task2.pendingFruitBtn   = null;
  closeT2Modal();
});

qs('#t2-cancel').addEventListener('click', ()=>{
  gameState.task2.pendingFruitIndex = null;
  gameState.task2.pendingFruitBtn   = null;
  closeT2Modal();
});

qs('#t2-save').addEventListener('click', ()=>{
  const minTxt = qs('#t2-minimise').value.trim();
  const eliTxt = qs('#t2-eliminate').value.trim();
  if (minTxt.length < 1 || eliTxt.length < 1){
    alert('Please provide detailed responses.');
    return;
  }

  const hazardId = currentHazardId;
  // Commit this response
  gameState.task2.responses.push({ hazardId, minimise: minTxt, eliminate: eliTxt });
  gameState.task2.chosenHazards.push(hazardId);

  // Now mark just this fruit as used
  const idx = gameState.task2.pendingFruitIndex;
  const btn = gameState.task2.pendingFruitBtn;
  if (btn) btn.classList.add('used');
  if (Number.isInteger(idx)) gameState.task2.usedFruitIndexes.add(idx);

  // Clear pending
  gameState.task2.pendingFruitIndex = null;
  gameState.task2.pendingFruitBtn   = null;

  renderT2Responses();
  updateT2Count();
  closeT2Modal();
});

function renderT2Responses(){
  const wrap = qs('#t2-responses');
  wrap.innerHTML = '';
  gameState.task2.responses.forEach((r)=>{
    const h = hazards[r.hazardId];
    const card = document.createElement('div');
    card.className = 'rounded-xl border border-gray-200 p-4 bg-gray-50';
    card.innerHTML = `
      <div class="flex items-start gap-3">
        <img src="${h.img}" alt="${h.alt||h.name}" class="square-thumb"/>
        <div class="flex-1">
          <h4 class="font-semibold text-gray-800">Hazard ${r.hazardId}: ${h.name}</h4>
          <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="bg-white border border-green-200 rounded p-3">
              <div class="text-xs font-semibold text-green-700 mb-1">Minimise</div>
              <p class="text-sm text-gray-700">${escapeHtml(r.minimise)}</p>
            </div>
            <div class="bg-white border border-blue-200 rounded p-3">
              <div class="text-xs font-semibold text-blue-700 mb-1">Eliminate</div>
              <p class="text-sm text-gray-700">${escapeHtml(r.eliminate)}</p>
            </div>
          </div>
          <p class="mt-2 text-xs text-gray-500">Submitted for teacher review</p>
        </div>
      </div>`;
    wrap.appendChild(card);
  });
}

function updateT2Count(){
  const done = (gameState.task2?.responses.length) || 0;
  const el = qs('#t2-count');
  if (el) el.textContent = done;
  if (done >= 3){
    qsa('#t2-bin .fruit').forEach(f => f.classList.add('used'));
    const btn = qs('#task2-complete');
    btn.classList.remove('hidden');
    btn.onclick = completeTask2;
  }
}

function completeTask2(){
  qsa('#t2-bin .fruit').forEach(f => f.disabled = true);
  const conf = document.createElement('div');
  conf.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-700 mt-4';
  conf.textContent = 'âœ… Your three hazard controls (both minimise & eliminate) have been recorded for assessor review.';
  qs('#task2').appendChild(conf);
  if (!gameState.completedTasks.includes(2)) gameState.completedTasks.push(2);
  updateProgress();
  showTask(3);
}

/* --------------  TASK 3 (Incident Form)  -------------- */
function checkTask3() {
  const formType       = document.querySelector('input[name="form-type"]:checked')?.value;
  const details        = Array.from(document.querySelectorAll('input[name="details"]:checked'))
                              .map(cb => cb.value);
  const notify         = document.querySelector('input[name="notify"]:checked')?.value;
  const worksafeTiming = document.querySelector('input[name="worksafe-timing"]:checked')?.value;

  if (!formType || !notify || !worksafeTiming) {
    alert('Please complete all questions before submitting.');
    return;
  }

  gameState.task3Responses = { formType, details, notify, worksafeTiming };

  document.getElementById('task3-complete').classList.remove('hidden');
  const conf = document.createElement('div');
  conf.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4';
  conf.innerHTML = `
    <h4 class="font-semibold text-blue-800">ğŸ“ Responses Submitted</h4>
    <p class="text-sm text-blue-600">
      Your incident reporting responses have been recorded for teacher review.
    </p>`;
  document.querySelector('#task3').appendChild(conf);
}
function completeTask3() {
  gameState.completedTasks.push(3);
  updateProgress();
  showTask(4);
}
/* ===== Task 4: Tap-to-order (summative, no instant feedback) ===== */
const T4_STEPS = [
  { key:'isolate',  text:'ğŸš§ Isolate the area and ensure scene safety' },
  { key:'assess',   text:'ğŸ©º Check for responsiveness and breathing' },
  { key:'call111',  text:'ğŸ“ Call 111 for emergency services' },
  { key:'firstaid', text:'ğŸ¥ Provide first aid as trained' },
  { key:'notify',   text:'ğŸ“‹ Notify supervisor and WorkSafe NZ' },
  { key:'preserve', text:'ğŸ” Preserve scene for investigation' },
];

let t4State = null;

function initializeTask4(){
  // fresh run each time Task 4 is shown
  t4State = {
    available: shuffle(T4_STEPS),      // uses your existing shuffle()
    slots: new Array(6).fill(null),    // {key,text} or null
    history: []                        // stack of {from:'pool'|'slot', index, item}
  };
  t4Render();
}

function t4Render(){
  // pool
  const pool = qs('#t4-pool'); 
  if (!pool) return;
  pool.innerHTML = '';
  t4State.available.forEach((item, i)=>{
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 't4-card';
    b.textContent = item.text;
    b.onclick = ()=> t4PlaceFromPool(i);
    pool.appendChild(b);
  });

  // slots: create once
  const slots = qs('#t4-slots');
  if (!slots) return;
  if (!slots.children.length){
    for (let i=0;i<6;i++){
      const s = document.createElement('button');
      s.type='button';
      s.className='t4-slot';
      s.dataset.index=i;
      s.textContent = `Step ${i+1}: Tap to place`;
      s.onclick = ()=> t4RemoveFromSlot(i);
      slots.appendChild(s);
    }
  }
  // fill visuals
  Array.from(slots.children).forEach((node,i)=>{
    const item = t4State.slots[i];
    if (item){
      node.classList.add('filled');
      node.textContent = item.text;
    }else{
      node.classList.remove('filled');
      node.textContent = `Step ${i+1}: Tap to place`;
    }
  });
}

function nextEmptySlot(){
  const idx = t4State.slots.findIndex(s => !s);
  return idx === -1 ? null : idx;
}

function t4PlaceFromPool(poolIndex){
  const slotIndex = nextEmptySlot();
  if (slotIndex === null) return; // already full
  const item = t4State.available.splice(poolIndex,1)[0];
  t4State.slots[slotIndex] = item;
  t4State.history.push({from:'pool', index:poolIndex, slot:slotIndex, item});
  t4Render();

  // When all 6 slots are filled, silently record and reveal "Complete" button
  if (nextEmptySlot() === null){
    const orderKeys  = t4State.slots.map(s=>s.key);
    const orderTexts = t4State.slots.map(s=>s.text);
    gameState.task4Sequence      = orderKeys;   // used in downloadSummary()
    gameState.task4SequenceTexts = orderTexts;  // human-readable backup

    // neutral confirmation (no correctness feedback)
    const conf = document.createElement('div');
    conf.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4';
    conf.innerHTML = `<h4 class="font-semibold text-blue-800">ğŸš¨ Emergency Sequence Recorded</h4>
      <p class="text-sm text-blue-600">Your chosen order has been saved for assessor review.</p>`;
    qs('#task4').appendChild(conf);

    const doneBtn = qs('#task4-complete');
    if (doneBtn) doneBtn.classList.remove('hidden');
  }
}

function t4RemoveFromSlot(slotIndex){
  const item = t4State.slots[slotIndex];
  if (!item) return;
  t4State.slots[slotIndex] = null;
  t4State.available.push(item);
  t4State.history.push({from:'slot', index:slotIndex, item});
  t4Render();

  // hide the completion button if they edit after filling
  const doneBtn = qs('#task4-complete');
  if (doneBtn) doneBtn.classList.add('hidden');
}

function t4Undo(){
  const h = t4State.history.pop(); 
  if (!h) return;
  if (h.from === 'pool'){
    // we placed from pool -> undo means remove from slot and return to pool
    t4State.slots[h.slot] = null;
    t4State.available.push(h.item);
  }else{
    // we removed from slot -> undo means put back in slot and remove last pool item
    const lastPoolIdx = t4State.available.length - 1;
    t4State.available.splice(lastPoolIdx,1);
    t4State.slots[h.index] = h.item;
  }
  t4Render();
}

function t4Clear(){
  t4State.available = [...t4State.available, ...t4State.slots.filter(Boolean)];
  t4State.slots = new Array(6).fill(null);
  t4State.history = [];
  t4Render();
}

function t4Shuffle(){
  t4State.available = shuffle(t4State.available);
  t4Render();
}
// Court verdict system
const TOTAL_REQUIRED = 2;   // â† only change needed if you add/remove cases later
const courtVerdicts = {};

// Override the earlier initializeTask5 to avoid errors (your Task 5 cases are static in the HTML)
function initializeTask5() {
  // No-op; keep HUD in sync if those elements exist
  updatePCBUHUD();
}

// Safe HUD updater (handles missing #pcbu-xp / #pcbu-lives gracefully)
function updatePCBUHUD () {
  const xpEl = document.getElementById('pcbu-xp');
  const livesEl = document.getElementById('pcbu-lives');
  if (xpEl)   xpEl.textContent    = pcbuXP;
  if (livesEl) livesEl.textContent = pcbuLives;
}

function deliverVerdict(caseNumber, verdict) {
  // Prevent double-submission on the same case
  if (courtVerdicts[caseNumber]) return;

  const reasoningEl = document.getElementById(`case${caseNumber}-reasoning`);
  const reasoning = reasoningEl ? reasoningEl.value.trim() : '';
  if (reasoning.length < 5) {
    alert('Please provide detailed judicial reasoning before delivering your verdict.');
    return;
  }

  // Store verdict and reasoning
  courtVerdicts[caseNumber] = { verdict, reasoning };

  // Update case UI
  const caseCard = document.getElementById(`case${caseNumber}`);
  if (!caseCard) return;

  const statusElement = caseCard.querySelector('.case-status');
  const verdictSection = caseCard.querySelector('.verdict-section');

  if (statusElement) {
    if (verdict === 'guilty') {
      statusElement.className = 'case-status bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium';
      statusElement.textContent = 'âš–ï¸ GUILTY';
      caseCard.className = 'case-card border-2 border-red-400 rounded-xl p-6 transition-all duration-300 bg-red-50';
    } else {
      statusElement.className = 'case-status bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium';
      statusElement.textContent = 'âš–ï¸ NOT GUILTY';
      caseCard.className = 'case-card border-2 border-green-400 rounded-xl p-6 transition-all duration-300 bg-green-50';
    }
  }

  if (verdictSection) {
    verdictSection.innerHTML = `
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <h5 class="font-semibold text-blue-800 mb-2">ğŸ“œ Verdict Delivered</h5>
        <p class="text-blue-700 text-sm"><strong>Decision:</strong> ${verdict.toUpperCase()}</p>
        <p class="text-blue-700 text-sm"><strong>Reasoning:</strong> ${reasoning}</p>
        <p class="text-xs text-blue-600 mt-2">âœ… Submitted for teacher review</p>
      </div>
    `;
  }

  updateCourtProgress();

  // Check if all required verdicts delivered
  const delivered = Object.keys(courtVerdicts).length;
  if (delivered >= TOTAL_REQUIRED) {
    const doneBtn = document.getElementById('task5-complete');
    if (doneBtn) doneBtn.classList.remove('hidden');

    // Final court summary
    const casesWrapper = document.getElementById('court-cases');
    if (casesWrapper && !document.getElementById('court-summary')) {
      const summaryDiv = document.createElement('div');
      summaryDiv.id = 'court-summary';
      summaryDiv.className = 'bg-amber-50 border-2 border-amber-300 rounded-xl p-6 mt-6';
      summaryDiv.innerHTML = `
        <div class="text-center">
          <div class="text-4xl mb-3">âš–ï¸</div>
          <h3 class="text-xl font-bold text-amber-800 mb-2">Court Session Complete!</h3>
          <p class="text-amber-700">All ${TOTAL_REQUIRED} cases have been reviewed and verdicts delivered. Your judicial decisions demonstrate understanding of PCBU duties under the Health & Safety at Work Act 2015.</p>
        </div>
      `;
      casesWrapper.appendChild(summaryDiv);
    }
  }
}

function updateCourtProgress() {
  const count = Object.keys(courtVerdicts).length;
  const reviewed = document.getElementById('cases-reviewed');
  const delivered = document.getElementById('verdicts-delivered');
  if (reviewed)  reviewed.textContent = count;
  if (delivered) delivered.textContent = count;
}

function completeTask5() {
  if (!gameState.completedTasks.includes(5)) {
    gameState.completedTasks.push(5);
  }
  updateProgress();
  showCompletionScreen();
}

function showCompletionScreen() {
  // Hide tasks if they exist
  for (let i = 1; i <= 5; i++) {
    const el = document.getElementById(`task${i}`);
    if (el) el.classList.add('hidden');
  }

  // Create completion screen if missing
  let done = document.getElementById('completion-screen');
  if (!done) {
    done = document.createElement('section');
    done.id = 'completion-screen';
    done.className = 'bg-white rounded-xl shadow-lg p-6 text-center';
    done.innerHTML = `
      <h2 class="text-2xl font-bold text-gray-900 mb-2">âœ… Assessment Submitted</h2>
      <p class="text-gray-700 mb-4">Your responses have been recorded for teacher review.</p>
      <button onclick="downloadSummary()"
              class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg">
        Download Summary
      </button>
    `;
    const main = document.querySelector('main') || document.body;
    main.appendChild(done);
  }
  done.classList.remove('hidden');
}

function updateProgress() {
  const progress = (gameState.completedTasks.length / 5) * 100;
  const bar = document.getElementById('progress-bar');
  const label = document.getElementById('progress-text');
  if (bar)   bar.style.width = `${progress}%`;
  if (label) label.textContent = `${gameState.completedTasks.length}/5 Tasks Complete`;
}

function downloadSummary () {
  let txt = `
HEALTH & SAFETY AT WORK ACT 2015 - STUDENT ASSESSMENT RESPONSES
Date: ${new Date().toLocaleDateString()}
Time: ${new Date().toLocaleTimeString()}

STUDENT RESPONSES FOR TEACHER REVIEW:\n\n`;

  // Task 1
  txt += 'TASK 1: HAZARD IDENTIFICATION\n';
  Object.keys(gameState.hazardDescriptions || {}).forEach(id => {
    txt += `Hazard ${id}: ${hazards[id].name}
Student Description: ${gameState.hazardDescriptions[id]}\n`;
  });

  // Task 2 (new structure)
  txt += '\nTASK 2: ELIMINATE vs MINIMISE (3 required)\n';
  if (gameState.task2 && gameState.task2.responses.length){
    gameState.task2.responses.forEach((r, idx) => {
      const h = hazards[r.hazardId];
      txt += `Item ${idx + 1}: Hazard ${r.hazardId} - ${h.name}
Minimise: ${r.minimise}
Eliminate: ${r.eliminate}\n`;
    });
  } else {
    txt += 'No Task 2 responses recorded.\n';
  }

  // Task 3
  txt += '\nTASK 3: INCIDENT REPORTING\n';
  if (gameState.task3Responses) {
    const r = gameState.task3Responses;
    txt += `Form Type: ${r.formType}
Details: ${r.details.join(', ')}
Notify: ${r.notify}
WorkSafe Timing: ${r.worksafeTiming}\n`;
  }

// Task 4
txt += '\nTASK 4: EMERGENCY PROCEDURES\n';
if (gameState.task4Sequence && gameState.task4Sequence.length){
  // map keys -> readable text for the export
  const T4_LABELS = {
    isolate:'Isolate the area and ensure scene safety',
    assess:'Check for responsiveness and breathing',
    call111:'Call 111 for emergency services',
    firstaid:'Provide first aid as trained',
    notify:'Notify supervisor and WorkSafe NZ',
    preserve:'Preserve scene for investigation'
  };
  txt += gameState.task4Sequence
    .map((k,i)=> `${i+1}. ${T4_LABELS[k] || k}`)
    .join('\n') + '\n';
} else if (gameState.task4SequenceTexts && gameState.task4SequenceTexts.length){
  txt += gameState.task4SequenceTexts
    .map((t,i)=> `${i+1}. ${t.replace(/^..\s/,'')}`) // strip emojis if desired
    .join('\n') + '\n';
} else {
  txt += 'No Task 4 sequence recorded.\n';
}

  // Task 5
  txt += '\nTASK 5: COURT VERDICTS\n';
  Object.keys(courtVerdicts || {}).forEach(num => {
    const v = courtVerdicts[num];
    txt += `Case ${num}: ${v.verdict.toUpperCase()}
Reasoning: ${v.reasoning}\n`;
  });

  txt += '\nASSESSMENT STATUS: SUBMITTED FOR TEACHER REVIEW';

  const blob = new Blob([txt], { type: 'text/plain' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url;
  a.download = 'Student_Health_Safety_Assessment_Responses.txt';
  a.click();
  URL.revokeObjectURL(url);
}

</script>

<!-- Accessibility: TTS + STT helpers (kept, moved before </body>) -->
<script>
/* -----------------------------------------------------------------
   1.  CONFIG
------------------------------------------------------------------*/
const SPEECH_LANG   = 'en-NZ';      // change if you need a different locale
const EAR_BTN_HTML  = '<i class="fa-solid fa-ear-listen"></i>';
const MIC_BTN_HTML  = '<i class="fa-solid fa-microphone"></i>';
const READABLE_SEL  = 'h1,h2,h3,h4,h5,h6,p,li,label,th,td,blockquote';

/* -----------------------------------------------------------------
   2.  TEXT-TO-SPEECH helpers
------------------------------------------------------------------*/
let preferredVoice = null;
const preferredVoiceNames = [
  'Google UK English Female','Google UK English Male',
  'Google US English','Microsoft David - English (United States)',
  'Microsoft Zira - English (United States)'
];
function chooseVoice(){
  const voices = speechSynthesis.getVoices();
  for (const name of preferredVoiceNames){
    const v = voices.find(v=>v.name === name);
    if (v) return v;
  }
  return voices.find(v=>v.lang && v.lang.startsWith('en-')) || null;
}
function speak(text){
  if(!text.trim()) return;
  const u = new SpeechSynthesisUtterance(text);
  if(!preferredVoice) preferredVoice = chooseVoice();
  if(preferredVoice) u.voice = preferredVoice;
  u.lang    = SPEECH_LANG;
  u.rate    = .9;
  speechSynthesis.speak(u);
}

/* -----------------------------------------------------------------
   3.  SPEECH-TO-TEXT helpers
------------------------------------------------------------------*/
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognizer = null, activeTarget = null;

function startRecognizer(target){
  if(!SpeechRecognition) return;
  if(!recognizer){
    recognizer = new SpeechRecognition();
    recognizer.lang = SPEECH_LANG;
    recognizer.interimResults = true;
    recognizer.continuous = false;

    recognizer.onresult = e=>{
      const txt = Array.from(e.results).map(r=>r[0].transcript).join('');
      if(activeTarget){
        activeTarget.value = txt;
        activeTarget.scrollTop = activeTarget.scrollHeight;
      }
    };
    recognizer.onend   = stopAllMicBtns;
    recognizer.onerror = stopAllMicBtns;
  }
  activeTarget = target;
  try{ recognizer.start(); }catch(_){ /* double-start safety */ }
}
function stopRecognizer(){
  if(recognizer){
    try{ recognizer.stop(); }catch(_){}
  }
  activeTarget = null;
}
function stopAllMicBtns(){
  document.querySelectorAll('.mic-btn.recording')
          .forEach(b=>b.classList.remove('recording'));
  stopRecognizer();
}

/* -----------------------------------------------------------------
   4.  DOM ENHANCEMENT
------------------------------------------------------------------*/
function addEarButtons(root=document){
  root.querySelectorAll(READABLE_SEL).forEach(el=>{
    if(!el.textContent.trim()) return;
    if(el.nextElementSibling?.classList?.contains('ear-btn')) return;
    const btn = document.createElement('button');
    btn.type  = 'button';
    btn.className = 'ear-btn inline-flex items-center justify-center ml-1 text-blue-600';
    btn.innerHTML = EAR_BTN_HTML;
    btn.addEventListener('click',()=> speak(
      el.tagName === 'TEXTAREA' ? el.value : el.textContent
    ));
    el.insertAdjacentElement('afterend', btn);
  });
}

function addMicButtons(root=document){
  root.querySelectorAll('textarea,input[type="text"]:not([data-no-mic])')
      .forEach(el=>{
        if(el.nextElementSibling?.classList?.contains('mic-btn')) return;
        const btn = document.createElement('button');
        btn.type  = 'button';
        btn.className = 'mic-btn ml-2';
        btn.setAttribute('aria-label','Start voice input');
        btn.innerHTML = MIC_BTN_HTML;
        btn.addEventListener('click', e=>{
          const myself = e.currentTarget;
          if(myself.classList.contains('recording')){
            myself.classList.remove('recording');
            stopRecognizer();
          }else{
            stopAllMicBtns();
            myself.classList.add('recording');
            startRecognizer(el);
          }
        });
        el.insertAdjacentElement('afterend', btn);
      });
}

/* -----------------------------------------------------------------
   5.  INITIALISE + observe for late-added nodes (e.g. modals)
------------------------------------------------------------------*/
function enhance(root=document){
  addEarButtons(root);
  addMicButtons(root);
}

document.addEventListener('DOMContentLoaded',()=>{
  // 5.1  first pass
  enhance(document);

  // 5.2  watch for future additions (hazard modal, dynamic templates, etc.)
  const mo = new MutationObserver(muts=>{
    muts.forEach(m=>{
      m.addedNodes.forEach(node=>{
        if(node.nodeType === 1){   // element
          enhance(node);
        }
      });
    });
  });
  mo.observe(document.body,{childList:true,subtree:true});

  // 5.3  voice list may load asynchronously
  if(!speechSynthesis.getVoices().length){
    speechSynthesis.addEventListener('voiceschanged', ()=> preferredVoice = chooseVoice());
  }else{
    preferredVoice = chooseVoice();
  }

  // 5.4  Hide all mic buttons gracefully if SpeechRecognition missing
  if(!SpeechRecognition){
    document.querySelectorAll('.mic-btn').forEach(b=>b.style.display='none');
  }
});
</script>
</body>
</html>
